<!DOCTYPE HTML>
<html>
<head>
  <meta charset="utf-8">
  
  <title>基于BEVDET剖析MMDet3D框架 | Untitled.</title>

  
  <meta name="author" content="Jingyi Yu">
  

  
  <meta name="description" content="本文基于BEVDET对MMDet3D框架进行了介绍">
  

  
  
  <meta name="keywords" content="Multi-view 3D">
  

  <meta id="viewport" name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no, minimal-ui">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">

  <meta property="og:title" content="基于BEVDET剖析MMDet3D框架"/>

  <meta property="og:site_name" content="Untitled."/>

  
  <meta property="og:image" content="/favicon.ico"/>
  

  <link href="/favicon.ico" rel="icon">
  <link rel="alternate" href="/atom.xml" title="Untitled." type="application/atom+xml">
  <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">
<meta name="generator" content="Hexo 6.3.0"></head>


<body>
<div class="blog">
  <div class="content">

    <header>
  <div class="site-branding">
    <h1 class="site-title">
      <a href="/">Untitled.</a>
    </h1>
    <p class="site-description"></p>
  </div>
  <nav class="site-navigation">
    <ul>
      
    </ul>
  </nav>
</header>

    <main class="site-main posts-loop">
    <article>

  
    
    <h3 class="article-title"><span>基于BEVDET剖析MMDet3D框架</span></h3>
    
  

  <div class="article-top-meta">
    <span class="posted-on">
      <a href="/2022/10/20/Code-基于BEVDET剖析MMDet3D架构/" rel="bookmark">
        <time class="entry-date published" datetime="2022-10-20T02:22:33.000Z">
          2022-10-20
        </time>
      </a>
    </span>
  </div>


  

  <div class="article-content">
    <div class="entry">
      
        <p>本文基于BEVDET对MMDet3D框架进行了介绍</p>
<span id="more"></span>

<h1 id="0-MMDetection3D简介"><a href="#0-MMDetection3D简介" class="headerlink" title="0.MMDetection3D简介"></a>0.MMDetection3D简介</h1><p><a target="_blank" rel="noopener" href="https://mmdetection3d.readthedocs.io/zh_CN/latest/">MMDet3D 官方文档</a>             <a target="_blank" rel="noopener" href="https://github.com/open-mmlab/mmdetection3d"> MMDet3D官方仓库</a></p>
<h2 id="选择MMDet3D的原因"><a href="#选择MMDet3D的原因" class="headerlink" title="选择MMDet3D的原因"></a>选择MMDet3D的原因</h2><ol>
<li>MMDetection3D 支持**<em>VoteNet</em><strong>,</strong>_ MVXNe__t_<strong>，</strong><em>PointPillars</em>**等多种算法，覆盖了单模态和多模态检测，室内和室外场景SOTA; 还可以直接使用训练MMDetection里面的所有300+模型和40+算法，支持算法的数量和覆盖方向为3D检测代码库之最。</li>
<li>MMDetection3D 支持**<em>SUN RGB-D</em>**, <strong><em>ScanNet</em></strong>, <strong><em>nuScenes</em></strong>, **<em>Lyft</em><strong>和</strong><em>KITTI</em>**共5个主流数据集，支持的数据集数量为3D检测代码库之最。</li>
<li>MMDetection3D 拥有最快的训练速度，支持pip install一键安装，简单易用。</li>
</ol>
<h1 id="1-BEVDET网络框架"><a href="#1-BEVDET网络框架" class="headerlink" title="1.BEVDET网络框架"></a>1.BEVDET网络框架</h1><p><img src="https://cdn.nlark.com/yuque/0/2022/png/478741/1666948035924-74c5970b-6112-4723-b1f9-46e3e0111e0d.png#clientId=u97f915e7-6927-4&crop=0&crop=0&crop=1&crop=1&from=drop&id=u6d0187ae&margin=%5Bobject%20Object%5D&name=%E6%88%AA%E5%B1%8F2022-10-28%2017.07.08.png&originHeight=932&originWidth=2192&originalType=binary&ratio=1&rotation=0&showTitle=false&size=1220852&status=done&style=none&taskId=u3c922d1d-7d73-4325-a0b7-ab7b0626dc0&title=#averageHue=%23d0d0cb&id=GmgFu&originHeight=932&originWidth=2192&originalType=binary&ratio=1&rotation=0&showTitle=false&status=done&style=none&title=" alt="截屏2022-10-28 17.07.08.png"><br>图1 BEVDET网络结构</p>
<h1 id="2-基于MMDet3D的BEVDET代码框架"><a href="#2-基于MMDet3D的BEVDET代码框架" class="headerlink" title="2.基于MMDet3D的BEVDET代码框架"></a>2.基于MMDet3D的BEVDET代码框架</h1><h2 id="2-1数据预处理"><a href="#2-1数据预处理" class="headerlink" title="2.1数据预处理"></a>2.1数据预处理</h2><h3 id="2-1-1-数据集定义"><a href="#2-1-1-数据集定义" class="headerlink" title="2.1.1 数据集定义"></a>2.1.1 数据集定义</h3><p>MMDet3D支持**<em>SUN RGB-D</em>**, <strong><em>ScanNet</em></strong>, <strong><em>nuScenes</em></strong>, **<em>Lyft</em><strong>和</strong><em>KITTI</em>**共5个主流数据集。对于上述数据集之外的公开数据集或者自定义数据集，可以通过继承 Custom3DDataset 来实现新的数据集类，并重载相关的方法，如 BEVDETNuScenesDataset数据集所示，该文件位于&#x2F;mmdet3d&#x2F;datasets&#x2F;bevdet_nuscenes_dataset.py。<br>数据集类中主要提供加载标注数据、转换数据格式、验证模型结果、定义数据集处理流程等相关功能。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> mmcv</span><br><span class="line"><span class="keyword">import</span> torch</span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">import</span> tempfile</span><br><span class="line"><span class="keyword">from</span> nuscenes.utils.data_classes <span class="keyword">import</span> Box <span class="keyword">as</span> NuScenesBox</span><br><span class="line"><span class="keyword">from</span> os <span class="keyword">import</span> path <span class="keyword">as</span> osp</span><br><span class="line"><span class="keyword">from</span> mmdet.datasets <span class="keyword">import</span> DATASETS</span><br><span class="line"><span class="keyword">from</span> ..core <span class="keyword">import</span> show_result</span><br><span class="line"><span class="keyword">from</span> ..core.bbox <span class="keyword">import</span> Box3DMode, Coord3DMode, LiDARInstance3DBoxes</span><br><span class="line"><span class="keyword">from</span> .custom_3d <span class="keyword">import</span> Custom3DDataset</span><br><span class="line"><span class="keyword">from</span> .pipelines <span class="keyword">import</span> Compose</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@DATASETS.register_module()</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">BEVDETNuScenesDataset</span>(<span class="title class_ inherited__">Custom3DDataset</span>):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">load_annotations</span>(<span class="params">self, ann_file</span>):</span><br><span class="line">    	<span class="string">&quot;&quot;&quot;Load annotations from ann_file.&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_format_bbox</span>(<span class="params">self, results, jsonfile_prefix=<span class="literal">None</span></span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;Convert the results to the standard format.&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line">        </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">evaluate</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;Evaluation in BEVDETNuScenesDataset protocol.&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">format_results</span>(<span class="params">self, results, jsonfile_prefix=<span class="literal">None</span></span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;Format the results to json&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_build_default_pipeline</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;Build the default pipeline for this dataset.&quot;&quot;&quot;</span></span><br></pre></td></tr></table></figure>
<h4 id=""><a href="#" class="headerlink" title=""></a></h4><h4 id="新增自定义数据集"><a href="#新增自定义数据集" class="headerlink" title="新增自定义数据集"></a>新增自定义数据集</h4><p>在 &#x2F;mmdet3d&#x2F;datasets&#x2F;my_dataset.py 中创建一个新的数据集类来进行数据的加载，如下所示。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">from</span> os <span class="keyword">import</span> path <span class="keyword">as</span> osp</span><br><span class="line"><span class="keyword">from</span> mmdet3d.core <span class="keyword">import</span> show_result</span><br><span class="line"><span class="keyword">from</span> mmdet3d.core.bbox <span class="keyword">import</span> DepthInstance3DBoxes</span><br><span class="line"><span class="keyword">from</span> mmdet.datasets <span class="keyword">import</span> DATASETS</span><br><span class="line"><span class="keyword">from</span> .custom_3d <span class="keyword">import</span> Custom3DDataset</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@DATASETS.register_module()</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">MyDataset</span>(<span class="title class_ inherited__">Custom3DDataset</span>):</span><br><span class="line">    CLASSES = (<span class="string">&#x27;cabinet&#x27;</span>, <span class="string">&#x27;bed&#x27;</span>, <span class="string">&#x27;chair&#x27;</span>, <span class="string">&#x27;sofa&#x27;</span>, <span class="string">&#x27;table&#x27;</span>, <span class="string">&#x27;door&#x27;</span>, <span class="string">&#x27;window&#x27;</span>,</span><br><span class="line">               <span class="string">&#x27;bookshelf&#x27;</span>, <span class="string">&#x27;picture&#x27;</span>, <span class="string">&#x27;counter&#x27;</span>, <span class="string">&#x27;desk&#x27;</span>, <span class="string">&#x27;curtain&#x27;</span>,</span><br><span class="line">               <span class="string">&#x27;refrigerator&#x27;</span>, <span class="string">&#x27;showercurtrain&#x27;</span>, <span class="string">&#x27;toilet&#x27;</span>, <span class="string">&#x27;sink&#x27;</span>, <span class="string">&#x27;bathtub&#x27;</span>,</span><br><span class="line">               <span class="string">&#x27;garbagebin&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self,</span></span><br><span class="line"><span class="params">                 data_root,</span></span><br><span class="line"><span class="params">                 ann_file,</span></span><br><span class="line"><span class="params">                 pipeline=<span class="literal">None</span>,</span></span><br><span class="line"><span class="params">                 classes=<span class="literal">None</span>,</span></span><br><span class="line"><span class="params">                 modality=<span class="literal">None</span>,</span></span><br><span class="line"><span class="params">                 box_type_3d=<span class="string">&#x27;Depth&#x27;</span>,</span></span><br><span class="line"><span class="params">                 filter_empty_gt=<span class="literal">True</span>,</span></span><br><span class="line"><span class="params">                 test_mode=<span class="literal">False</span></span>):</span><br><span class="line">        <span class="built_in">super</span>().__init__(</span><br><span class="line">            data_root=data_root,</span><br><span class="line">            ann_file=ann_file,</span><br><span class="line">            pipeline=pipeline,</span><br><span class="line">            classes=classes,</span><br><span class="line">            modality=modality,</span><br><span class="line">            box_type_3d=box_type_3d,</span><br><span class="line">            filter_empty_gt=filter_empty_gt,</span><br><span class="line">            test_mode=test_mode)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">get_ann_info</span>(<span class="params">self, index</span>):</span><br><span class="line">        <span class="comment"># 通过下标来获取标注信息，evalhook 也能够通过此接口来获取标注信息</span></span><br><span class="line">        info = self.data_infos[index]</span><br><span class="line">        <span class="keyword">if</span> info[<span class="string">&#x27;annos&#x27;</span>][<span class="string">&#x27;gt_num&#x27;</span>] != <span class="number">0</span>:</span><br><span class="line">            gt_bboxes_3d = info[<span class="string">&#x27;annos&#x27;</span>][<span class="string">&#x27;gt_boxes_upright_depth&#x27;</span>].astype(</span><br><span class="line">                np.float32)  <span class="comment"># k, 6</span></span><br><span class="line">            gt_labels_3d = info[<span class="string">&#x27;annos&#x27;</span>][<span class="string">&#x27;class&#x27;</span>].astype(np.int64)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            gt_bboxes_3d = np.zeros((<span class="number">0</span>, <span class="number">6</span>), dtype=np.float32)</span><br><span class="line">            gt_labels_3d = np.zeros((<span class="number">0</span>, ), dtype=np.int64)</span><br><span class="line">        <span class="comment"># 转换为目标标注框的结构</span></span><br><span class="line">        gt_bboxes_3d = DepthInstance3DBoxes(</span><br><span class="line">            gt_bboxes_3d,</span><br><span class="line">            box_dim=gt_bboxes_3d.shape[-<span class="number">1</span>],</span><br><span class="line">            with_yaw=<span class="literal">False</span>,</span><br><span class="line">            origin=(<span class="number">0.5</span>, <span class="number">0.5</span>, <span class="number">0.5</span>)).convert_to(self.box_mode_3d)</span><br><span class="line">        pts_instance_mask_path = osp.join(self.data_root,</span><br><span class="line">                                          info[<span class="string">&#x27;pts_instance_mask_path&#x27;</span>])</span><br><span class="line">        pts_semantic_mask_path = osp.join(self.data_root,</span><br><span class="line">                                          info[<span class="string">&#x27;pts_semantic_mask_path&#x27;</span>])</span><br><span class="line">        anns_results = <span class="built_in">dict</span>(</span><br><span class="line">            gt_bboxes_3d=gt_bboxes_3d,</span><br><span class="line">            gt_labels_3d=gt_labels_3d,</span><br><span class="line">            pts_instance_mask_path=pts_instance_mask_path,</span><br><span class="line">            pts_semantic_mask_path=pts_semantic_mask_path)</span><br><span class="line">        <span class="keyword">return</span> anns_results</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>修改配置文件来调用 MyDataset 数据集类，如下所示。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">dataset_A_train = <span class="built_in">dict</span>(</span><br><span class="line">    <span class="built_in">type</span>=<span class="string">&#x27;MyDataset&#x27;</span>,</span><br><span class="line">    ann_file = <span class="string">&#x27;annotation.pkl&#x27;</span>,</span><br><span class="line">    pipeline=train_pipeline</span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<h3 id="2-1-2-数据预处理流程"><a href="#2-1-2-数据预处理流程" class="headerlink" title="2.1.2 数据预处理流程"></a>2.1.2 数据预处理流程</h3><p>数据预处理流程和数据集之间是互相分离的两个部分，通常数据集定义了如何处理标注信息，而数据预处理流程定义了准备数据项字典的所有步骤。数据集预处理流程包含一系列的操作，每个操作将一个字典作为输入，并输出应用于下一个转换的一个新的字典。<br>图2是一个最经典的数据集预处理流程，其中蓝色框表示预处理流程中的各项操作。随着预处理的进行，每一个操作都会添加新的键值（图中标记为绿色）到输出字典中，或者更新当前存在的键值（图中标记为橙色）。<br><img src="https://cdn.nlark.com/yuque/0/2022/png/478741/1667200896660-27698477-fb06-47c7-8031-229b959ac09b.png#clientId=u5a86381d-9405-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=318&id=u090dea26&margin=%5Bobject%20Object%5D&name=image.png&originHeight=398&originWidth=1788&originalType=binary&ratio=1&rotation=0&showTitle=false&size=340808&status=done&style=none&taskId=u893c5257-2ea9-44d0-9330-73e7395dac1&title=&width=1430.4#averageHue=%23faf9f9&id=kwdD0&originHeight=398&originWidth=1788&originalType=binary&ratio=1&rotation=0&showTitle=false&status=done&style=none&title=" alt="image.png"><br>图2 数据集预处理流程</p>
<p>预处理流程中的各项操作主要分为数据加载、预处理、格式化、测试时的数据增强。以BEVDET为例，我们对预处理流程中各项操作进行具体的分析。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">train_pipeline = [</span><br><span class="line">    <span class="built_in">dict</span>(<span class="built_in">type</span>=<span class="string">&#x27;LoadMultiViewImageFromFiles_BEVDet&#x27;</span>, is_train=<span class="literal">True</span>, data_config=data_config),</span><br><span class="line">    <span class="built_in">dict</span>(<span class="built_in">type</span>=<span class="string">&#x27;LoadPointsFromFile&#x27;</span>,</span><br><span class="line">        coord_type=<span class="string">&#x27;LIDAR&#x27;</span>,</span><br><span class="line">        load_dim=<span class="number">5</span>,</span><br><span class="line">        use_dim=<span class="number">5</span>,</span><br><span class="line">        file_client_args=file_client_args),</span><br><span class="line">    <span class="built_in">dict</span>(<span class="built_in">type</span>=<span class="string">&#x27;LoadAnnotations3D&#x27;</span>, with_bbox_3d=<span class="literal">True</span>, with_label_3d=<span class="literal">True</span>),</span><br><span class="line">    <span class="built_in">dict</span>(<span class="built_in">type</span>=<span class="string">&#x27;GlobalRotScaleTrans&#x27;</span>,</span><br><span class="line">        rot_range=[-<span class="number">0.3925</span>, <span class="number">0.3925</span>],</span><br><span class="line">        scale_ratio_range=[<span class="number">0.95</span>, <span class="number">1.05</span>],</span><br><span class="line">        translation_std=[<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>],</span><br><span class="line">        update_img2lidar=<span class="literal">True</span>),</span><br><span class="line">    <span class="built_in">dict</span>(<span class="built_in">type</span>=<span class="string">&#x27;RandomFlip3D&#x27;</span>,</span><br><span class="line">        sync_2d=<span class="literal">False</span>,</span><br><span class="line">        flip_ratio_bev_horizontal=<span class="number">0.5</span>,</span><br><span class="line">        flip_ratio_bev_vertical=<span class="number">0.5</span>,</span><br><span class="line">        update_img2lidar=<span class="literal">True</span>),</span><br><span class="line">    <span class="built_in">dict</span>(<span class="built_in">type</span>=<span class="string">&#x27;ObjectRangeFilter&#x27;</span>, point_cloud_range=point_cloud_range),</span><br><span class="line">    <span class="built_in">dict</span>(<span class="built_in">type</span>=<span class="string">&#x27;ObjectNameFilter&#x27;</span>, classes=class_names),</span><br><span class="line">    <span class="built_in">dict</span>(<span class="built_in">type</span>=<span class="string">&#x27;DefaultFormatBundle3D&#x27;</span>, class_names=class_names),</span><br><span class="line">    <span class="built_in">dict</span>(<span class="built_in">type</span>=<span class="string">&#x27;Collect3D&#x27;</span>, keys=[<span class="string">&#x27;img_inputs&#x27;</span>, <span class="string">&#x27;gt_bboxes_3d&#x27;</span>, <span class="string">&#x27;gt_labels_3d&#x27;</span>],</span><br><span class="line">         meta_keys=(<span class="string">&#x27;filename&#x27;</span>, <span class="string">&#x27;ori_shape&#x27;</span>, <span class="string">&#x27;img_shape&#x27;</span>, <span class="string">&#x27;lidar2img&#x27;</span>,</span><br><span class="line">                            <span class="string">&#x27;depth2img&#x27;</span>, <span class="string">&#x27;cam2img&#x27;</span>, <span class="string">&#x27;pad_shape&#x27;</span>,</span><br><span class="line">                            <span class="string">&#x27;scale_factor&#x27;</span>, <span class="string">&#x27;flip&#x27;</span>, <span class="string">&#x27;pcd_horizontal_flip&#x27;</span>,</span><br><span class="line">                            <span class="string">&#x27;pcd_vertical_flip&#x27;</span>, <span class="string">&#x27;box_mode_3d&#x27;</span>, <span class="string">&#x27;box_type_3d&#x27;</span>,</span><br><span class="line">                            <span class="string">&#x27;img_norm_cfg&#x27;</span>, <span class="string">&#x27;pcd_trans&#x27;</span>, <span class="string">&#x27;sample_idx&#x27;</span>,</span><br><span class="line">                            <span class="string">&#x27;pcd_scale_factor&#x27;</span>, <span class="string">&#x27;pcd_rotation&#x27;</span>, <span class="string">&#x27;pts_filename&#x27;</span>,</span><br><span class="line">                            <span class="string">&#x27;transformation_3d_flow&#x27;</span>, <span class="string">&#x27;img_info&#x27;</span>))</span><br><span class="line">]</span><br></pre></td></tr></table></figure>

<p>上述流程中涉及到的各项操作及其在MMDet3D框架下的实际位置如表1所示。Collect3D最后返回的img_meta包含模型输入的全部数据。<br>表1 BEVDET相关数据处理操作</p>
<table>
<thead>
<tr>
<th>操作项</th>
<th>数据处理操作</th>
<th>功能</th>
<th>代码位置</th>
</tr>
</thead>
<tbody><tr>
<td>数据加载</td>
<td>LoadMultiViewImageFromFiles_BEVDet</td>
<td>加载六个相机的单帧图像，进行图像的缩放和裁剪操作等</td>
<td>&#x2F;mmdet3d&#x2F;datasets&#x2F;pipelines&#x2F;loading.py</td>
</tr>
<tr>
<td></td>
<td>LoadPointsFromFile</td>
<td>加载LiDAR点云（如果不需要点云数据可以不加载）</td>
<td></td>
</tr>
<tr>
<td></td>
<td>LoadAnnotations3D</td>
<td>加载标注数据</td>
<td></td>
</tr>
<tr>
<td>数据预处理</td>
<td>GlobalRotScaleTrans</td>
<td>对于点云数据的旋转、平移、缩放</td>
<td>&#x2F;mmdet3d&#x2F;datasets&#x2F;pipelines&#x2F;transforms_3d.py</td>
</tr>
<tr>
<td></td>
<td>RandomFlip3D</td>
<td>翻转点云和目标框</td>
<td></td>
</tr>
<tr>
<td></td>
<td>ObjectRangeFilter</td>
<td>根据范围过滤目标框</td>
<td></td>
</tr>
<tr>
<td></td>
<td>ObjectNameFilter</td>
<td>根据类别过滤目标框</td>
<td></td>
</tr>
<tr>
<td>格式化</td>
<td>DefaultFormatBundle3D</td>
<td>格式化真值数据</td>
<td>&#x2F;mmdet3d&#x2F;datasets&#x2F;pipelines&#x2F;formating.py</td>
</tr>
<tr>
<td></td>
<td>Collect3D</td>
<td>添加img_meta （由 meta_keys 指定的键值构成的 img_meta），移除所有除 keys 指定的键值以外的其他键值</td>
<td></td>
</tr>
</tbody></table>
<h4 id="新增自定义数据处理方法"><a href="#新增自定义数据处理方法" class="headerlink" title="新增自定义数据处理方法"></a>新增自定义数据处理方法</h4><p>在 &#x2F;mmdet3d&#x2F;datasets&#x2F;pipelines&#x2F;my_pipeline.py中写入新的数据集预处理方法，该预处理方法的输入和输出均为字典</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> mmdet.datasets <span class="keyword">import</span> PIPELINES</span><br><span class="line"></span><br><span class="line"><span class="meta">@PIPELINES.register_module()</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">MyTransform</span>:</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__call__</span>(<span class="params">self, results</span>):</span><br><span class="line">        results[<span class="string">&#x27;dummy&#x27;</span>] = <span class="literal">True</span></span><br><span class="line">        <span class="keyword">return</span> results</span><br></pre></td></tr></table></figure>

<p>在&#x2F;mmdet3d&#x2F;datasets&#x2F;pipelines&#x2F;<strong>init</strong>.py 中导入新的数据处理方法</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> .my_pipeline <span class="keyword">import</span> MyTransform</span><br></pre></td></tr></table></figure>

<p>在配置文件中使用该数据预处理方法</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">train_pipeline = [</span><br><span class="line">    <span class="built_in">dict</span>(</span><br><span class="line">        <span class="built_in">type</span>=<span class="string">&#x27;LoadPointsFromFile&#x27;</span>,</span><br><span class="line">        load_dim=<span class="number">5</span>,</span><br><span class="line">        use_dim=<span class="number">5</span>,</span><br><span class="line">        file_client_args=file_client_args),</span><br><span class="line">    <span class="string">&quot;&quot;&quot;...&quot;&quot;&quot;</span></span><br><span class="line">    <span class="built_in">dict</span>(<span class="built_in">type</span>=<span class="string">&#x27;MyTransform&#x27;</span>),</span><br><span class="line">    <span class="string">&quot;&quot;&quot;...&quot;&quot;&quot;</span></span><br><span class="line">    <span class="built_in">dict</span>(<span class="built_in">type</span>=<span class="string">&#x27;Collect3D&#x27;</span>, keys=[<span class="string">&#x27;points&#x27;</span>, <span class="string">&#x27;gt_bboxes_3d&#x27;</span>, <span class="string">&#x27;gt_labels_3d&#x27;</span>])</span><br><span class="line">]</span><br></pre></td></tr></table></figure>

<h2 id="2-2模型"><a href="#2-2模型" class="headerlink" title="2.2模型"></a>2.2模型</h2><h3 id="2-2-1-配置模型结构"><a href="#2-2-1-配置模型结构" class="headerlink" title="2.2.1 配置模型结构"></a>2.2.1 配置模型结构</h3><p>MMDet3D使用config文件配置模型结构，BEVDET-sttiny版本的模型配置部分如下</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line">model = <span class="built_in">dict</span>(<span class="built_in">type</span>=<span class="string">&#x27;BEVDet&#x27;</span>,</span><br><span class="line">    img_backbone=<span class="built_in">dict</span>(<span class="built_in">type</span>=<span class="string">&#x27;SwinTransformer&#x27;</span>,</span><br><span class="line">        pretrained=<span class="string">&#x27;https://github.com/SwinTransformer/storage/releases/download/v1.0.0/swin_tiny_patch4_window7_224.pth&#x27;</span>,</span><br><span class="line">        pretrain_img_size=<span class="number">224</span>,</span><br><span class="line">        embed_dims=<span class="number">96</span>,</span><br><span class="line">        patch_size=<span class="number">4</span>,</span><br><span class="line">        window_size=<span class="number">7</span>,</span><br><span class="line">        mlp_ratio=<span class="number">4</span>,</span><br><span class="line">        depths=[<span class="number">2</span>, <span class="number">2</span>, <span class="number">6</span>, <span class="number">2</span>],</span><br><span class="line">        num_heads=[<span class="number">3</span>, <span class="number">6</span>, <span class="number">12</span>, <span class="number">24</span>],</span><br><span class="line">        strides=(<span class="number">4</span>, <span class="number">2</span>, <span class="number">2</span>, <span class="number">2</span>),</span><br><span class="line">        out_indices=(<span class="number">2</span>, <span class="number">3</span>,),</span><br><span class="line">        qkv_bias=<span class="literal">True</span>,</span><br><span class="line">        qk_scale=<span class="literal">None</span>,</span><br><span class="line">        patch_norm=<span class="literal">True</span>,</span><br><span class="line">        drop_rate=<span class="number">0.</span>,</span><br><span class="line">        attn_drop_rate=<span class="number">0.</span>,</span><br><span class="line">        drop_path_rate=<span class="number">0.0</span>,</span><br><span class="line">        use_abs_pos_embed=<span class="literal">False</span>,</span><br><span class="line">        act_cfg=<span class="built_in">dict</span>(<span class="built_in">type</span>=<span class="string">&#x27;GELU&#x27;</span>),</span><br><span class="line">        norm_cfg=<span class="built_in">dict</span>(<span class="built_in">type</span>=<span class="string">&#x27;LN&#x27;</span>, requires_grad=<span class="literal">True</span>),</span><br><span class="line">        pretrain_style=<span class="string">&#x27;official&#x27;</span>,</span><br><span class="line">        output_missing_index_as_none=<span class="literal">False</span>),</span><br><span class="line">    img_neck=<span class="built_in">dict</span>(<span class="built_in">type</span>=<span class="string">&#x27;FPN_LSS&#x27;</span>,</span><br><span class="line">        in_channels=<span class="number">384</span>+<span class="number">768</span>,</span><br><span class="line">        out_channels=<span class="number">512</span>,</span><br><span class="line">        extra_upsample=<span class="literal">None</span>,</span><br><span class="line">        input_feature_index=(<span class="number">0</span>,<span class="number">1</span>),</span><br><span class="line">        scale_factor=<span class="number">2</span>),</span><br><span class="line">    img_view_transformer=<span class="built_in">dict</span>(<span class="built_in">type</span>=<span class="string">&#x27;ViewTransformerLiftSplatShoot&#x27;</span>, grid_config=grid_config, data_config=data_config, numC_Trans=numC_Trans),</span><br><span class="line">    img_bev_encoder_backbone = <span class="built_in">dict</span>(<span class="built_in">type</span>=<span class="string">&#x27;ResNetForBEVDet&#x27;</span>, numC_input=numC_Trans),</span><br><span class="line">    img_bev_encoder_neck = <span class="built_in">dict</span>(<span class="built_in">type</span>=<span class="string">&#x27;FPN_LSS&#x27;</span>, in_channels=numC_Trans*<span class="number">8</span>+numC_Trans*<span class="number">2</span>, out_channels=<span class="number">256</span>),</span><br><span class="line">    pts_bbox_head=<span class="built_in">dict</span>(<span class="built_in">type</span>=<span class="string">&#x27;CenterHeadBEVDet&#x27;</span>,</span><br><span class="line">        in_channels=<span class="number">256</span>,</span><br><span class="line">        tasks=[<span class="built_in">dict</span>(num_class=<span class="number">1</span>, class_names=[<span class="string">&#x27;car&#x27;</span>]),</span><br><span class="line">            <span class="built_in">dict</span>(num_class=<span class="number">2</span>, class_names=[<span class="string">&#x27;truck&#x27;</span>, <span class="string">&#x27;construction_vehicle&#x27;</span>]),</span><br><span class="line">            <span class="built_in">dict</span>(num_class=<span class="number">2</span>, class_names=[<span class="string">&#x27;bus&#x27;</span>, <span class="string">&#x27;trailer&#x27;</span>]),</span><br><span class="line">            <span class="built_in">dict</span>(num_class=<span class="number">1</span>, class_names=[<span class="string">&#x27;barrier&#x27;</span>]),</span><br><span class="line">            <span class="built_in">dict</span>(num_class=<span class="number">2</span>, class_names=[<span class="string">&#x27;motorcycle&#x27;</span>, <span class="string">&#x27;bicycle&#x27;</span>]),</span><br><span class="line">            <span class="built_in">dict</span>(num_class=<span class="number">2</span>, class_names=[<span class="string">&#x27;pedestrian&#x27;</span>, <span class="string">&#x27;traffic_cone&#x27;</span>]),</span><br><span class="line">        ],</span><br><span class="line">        common_heads=<span class="built_in">dict</span>(reg=(<span class="number">2</span>, <span class="number">2</span>), height=(<span class="number">1</span>, <span class="number">2</span>), dim=(<span class="number">3</span>, <span class="number">2</span>), rot=(<span class="number">2</span>, <span class="number">2</span>), vel=(<span class="number">2</span>, <span class="number">2</span>)),</span><br><span class="line">        share_conv_channel=<span class="number">64</span>,</span><br><span class="line">        bbox_coder=<span class="built_in">dict</span>(<span class="built_in">type</span>=<span class="string">&#x27;CenterPointBBoxCoder&#x27;</span>,</span><br><span class="line">            pc_range=point_cloud_range[:<span class="number">2</span>],</span><br><span class="line">            post_center_range=[-<span class="number">61.2</span>, -<span class="number">61.2</span>, -<span class="number">10.0</span>, <span class="number">61.2</span>, <span class="number">61.2</span>, <span class="number">10.0</span>],</span><br><span class="line">            max_num=<span class="number">500</span>,</span><br><span class="line">            score_threshold=<span class="number">0.1</span>,</span><br><span class="line">            out_size_factor=<span class="number">8</span>,</span><br><span class="line">            voxel_size=voxel_size[:<span class="number">2</span>],</span><br><span class="line">            code_size=<span class="number">9</span>),</span><br><span class="line">        separate_head=<span class="built_in">dict</span>(<span class="built_in">type</span>=<span class="string">&#x27;SeparateHead&#x27;</span>, init_bias=-<span class="number">2.19</span>, final_kernel=<span class="number">3</span>),</span><br><span class="line">        loss_cls=<span class="built_in">dict</span>(<span class="built_in">type</span>=<span class="string">&#x27;GaussianFocalLoss&#x27;</span>, reduction=<span class="string">&#x27;mean&#x27;</span>),</span><br><span class="line">        loss_bbox=<span class="built_in">dict</span>(<span class="built_in">type</span>=<span class="string">&#x27;L1Loss&#x27;</span>, reduction=<span class="string">&#x27;mean&#x27;</span>, loss_weight=<span class="number">0.25</span>),</span><br><span class="line">        norm_bbox=<span class="literal">True</span>),</span><br><span class="line">    )  <span class="comment"># 省略了模型的训练和配置信息</span></span><br></pre></td></tr></table></figure>


<p>上述模块划分与论文中的模块划分基本一致，其对应关系以及在MMDet3D框架下的实际位置如表2所示<br>表2  BEVDET的模型配置</p>
<table>
<thead>
<tr>
<th>论文模块</th>
<th>代码模块</th>
<th>Tensor Size</th>
<th>类型</th>
<th>代码位置</th>
<th>原论文</th>
</tr>
</thead>
<tbody><tr>
<td>Image-view Encoder</td>
<td>img_backbone</td>
<td>[B, N, 3, 256, 704]</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>$\downarrow$</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>[[B, N, 384, 16, 44],</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>[B, N, 768, 8, 22]]</td>
<td>SwinTransformer</td>
<td>mmdet3d&#x2F;models&#x2F;backbones&#x2F;swin.py</td>
<td>Swin Transformer: Hierarchical Vision Transformer using Shifted Windows</td>
<td></td>
<td></td>
</tr>
<tr>
<td></td>
<td>img_neck</td>
<td>[[B, N, 384, 16, 44],</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>[B, N, 768, 8, 22]]</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>$\downarrow$</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>[B, N, 512, 16, 44]</td>
<td>FPN_LSS</td>
<td>mmdet3d&#x2F;models&#x2F;necks&#x2F;lss_fpn.py</td>
<td>Feature Pyramid Networks for Object Detection</td>
<td></td>
<td></td>
</tr>
<tr>
<td>View Transformer</td>
<td>img_view_transformer</td>
<td>[B, N, 512, 16, 44]</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>$\downarrow$</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>[B, 64, 128, 128]</td>
<td>ViewTransformerLSS</td>
<td>mmdet3d&#x2F;models&#x2F;necks&#x2F;view_transformer_bevdet_bevdepth.py</td>
<td>Lift, Splat, Shoot: Encoding Images From Arbitrary Camera Rigs by Implicitly Unprojecting to 3D</td>
<td></td>
<td></td>
</tr>
<tr>
<td>BEVEncoder</td>
<td>img_bev_encoder_backbone</td>
<td>[B, 64, 128, 128]</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>$\downarrow$</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>[[B, 128, 64, 64],</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>[B, 256, 32, 32],</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>[B, 512, 16, 16]]</td>
<td>ResNetForBevDet</td>
<td>mmdet3d&#x2F;models&#x2F;backbones&#x2F;resnet.py</td>
<td>Deep Residual Learning for Image Recognition</td>
<td></td>
<td></td>
</tr>
<tr>
<td></td>
<td>img_bev_encoder_neck</td>
<td>[[B, 128, 64, 64],</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>[B, 256, 32, 32],</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>[B, 512, 16, 16]]</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>$\downarrow$</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>[B, 256, 128, 128]</td>
<td>FPN_LSS</td>
<td>mmdet3d&#x2F;models&#x2F;necks&#x2F;lss_fpn.py</td>
<td>Feature Pyramid Networks for Object Detection</td>
<td></td>
<td></td>
</tr>
<tr>
<td>Head</td>
<td>pts_bbox_head</td>
<td>[B, 256, 128, 128]</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>$\downarrow$</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>[B, …, 128, 128]</td>
<td>CenterHeadBEVDet</td>
<td>mmdet3d&#x2F;models&#x2F;dense_heads&#x2F;centerpoint_head_bevdet.py</td>
<td>Center-based 3D Object Detection and Tracking</td>
<td></td>
<td></td>
</tr>
</tbody></table>
<h3 id="2-2-2-模型的各个组件"><a href="#2-2-2-模型的各个组件" class="headerlink" title="2.2.2 模型的各个组件"></a>2.2.2 模型的各个组件</h3><p>MMDet3D通常把模型的各个组成成分分成6种类型：</p>
<ul>
<li>骨干网络（backbone）：通常采用 FCN 网络来提取特征图，如 **_ResNet _**和 **<em>SECOND</em>**。</li>
<li>颈部网络（neck）：位于 backbones 和 heads 之间的组成模块，如**_ FPN_** 和 **<em>SECONDFPN</em>**。</li>
<li>RoI 提取器（RoI extractor）：用于从特征图中提取 RoI 特征的组成模块，如**_ H3DRoIHead_** 和 **<em>PartAggregationROIHead</em>**。</li>
<li>编码器（encoder）：包括 voxel layer、voxel encoder 和 middle encoder 等进入 backbone 前所使用的基于 voxel 的方法，如 <strong><em>HardVFE</em></strong> 和**_ PointPillarsScatter_**。</li>
<li>检测头（head）：用于特定任务的组成模块，如检测框的预测和掩码的预测。</li>
<li>损失函数（loss）：heads 中用于计算损失函数的组成模块，如**_ FocalLoss_<strong>、</strong><em>L1Loss</em>** 和**_ GHMLoss_**。</li>
</ul>
<h4 id="Detector"><a href="#Detector" class="headerlink" title="Detector"></a>Detector</h4><p>对于3D检测模型，模型的总体框架由Dectectors定义，也即BEVDET-sttiny的配置文件中，model的type。在Detector中定义从输入的六张图像到模型输出结果的模型训练、测试的整体流程，包括对模型各子组件的调用。对于BEVDET-sttiny，其model的type为“BEVDet”，具体定义如下</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> torch</span><br><span class="line"><span class="keyword">from</span> mmcv.runner <span class="keyword">import</span> force_fp32</span><br><span class="line"><span class="keyword">import</span> torch.nn.functional <span class="keyword">as</span> F</span><br><span class="line"><span class="keyword">from</span> mmdet.models <span class="keyword">import</span> DETECTORS</span><br><span class="line"><span class="keyword">from</span> .centerpoint <span class="keyword">import</span> CenterPoint</span><br><span class="line"><span class="keyword">from</span> .. <span class="keyword">import</span> builder</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@DETECTORS.register_module()</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">BEVDet</span>(<span class="title class_ inherited__">CenterPoint</span>):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, img_view_transformer, img_bev_encoder_backbone, img_bev_encoder_neck, **kwargs</span>):</span><br><span class="line">        <span class="built_in">super</span>(BEVDet, self).__init__(**kwargs)</span><br><span class="line">        self.img_view_transformer = builder.build_neck(img_view_transformer)</span><br><span class="line">        self.img_bev_encoder_backbone = builder.build_backbone(img_bev_encoder_backbone)</span><br><span class="line">        self.img_bev_encoder_neck = builder.build_neck(img_bev_encoder_neck)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">image_encoder</span>(<span class="params">self, img</span>):</span><br><span class="line">        imgs = img</span><br><span class="line">        B, N, C, imH, imW = imgs.shape</span><br><span class="line">        imgs = imgs.view(B * N, C, imH, imW)</span><br><span class="line">        x = self.img_backbone(imgs)</span><br><span class="line">        <span class="keyword">if</span> self.with_img_neck:</span><br><span class="line">            x = self.img_neck(x)</span><br><span class="line">        _, output_dim, ouput_H, output_W = x.shape</span><br><span class="line">        x = x.view(B, N, output_dim, ouput_H, output_W)</span><br><span class="line">        <span class="keyword">return</span> x</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">bev_encoder</span>(<span class="params">self, x</span>):</span><br><span class="line">        x = self.img_bev_encoder_backbone(x)</span><br><span class="line">        x = self.img_bev_encoder_neck(x)</span><br><span class="line">        <span class="keyword">return</span> x</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">extract_img_feat</span>(<span class="params">self, img, img_metas</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;Extract features of images.&quot;&quot;&quot;</span></span><br><span class="line">        x = self.image_encoder(img[<span class="number">0</span>])</span><br><span class="line">        x = self.img_view_transformer([x] + img[<span class="number">1</span>:])</span><br><span class="line">        x = self.bev_encoder(x)</span><br><span class="line">        <span class="keyword">return</span> [x]</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">extract_feat</span>(<span class="params">self, points, img, img_metas</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;Extract features from images and points.&quot;&quot;&quot;</span></span><br><span class="line">        img_feats = self.extract_img_feat(img, img_metas)</span><br><span class="line">        pts_feats = <span class="literal">None</span></span><br><span class="line">        <span class="keyword">return</span> (img_feats, pts_feats)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">forward_train</span>(<span class="params">self,</span></span><br><span class="line"><span class="params">                      points=<span class="literal">None</span>,</span></span><br><span class="line"><span class="params">                      img_metas=<span class="literal">None</span>,</span></span><br><span class="line"><span class="params">                      gt_bboxes_3d=<span class="literal">None</span>,</span></span><br><span class="line"><span class="params">                      gt_labels_3d=<span class="literal">None</span>,</span></span><br><span class="line"><span class="params">                      gt_labels=<span class="literal">None</span>,</span></span><br><span class="line"><span class="params">                      gt_bboxes=<span class="literal">None</span>,</span></span><br><span class="line"><span class="params">                      img_inputs=<span class="literal">None</span>,</span></span><br><span class="line"><span class="params">                      proposals=<span class="literal">None</span>,</span></span><br><span class="line"><span class="params">                      gt_bboxes_ignore=<span class="literal">None</span></span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;Forward training function.&quot;&quot;&quot;</span></span><br><span class="line">        img_feats, pts_feats = self.extract_feat(</span><br><span class="line">            points, img=img_inputs, img_metas=img_metas)</span><br><span class="line">        <span class="keyword">assert</span> self.with_pts_bbox</span><br><span class="line">        losses = <span class="built_in">dict</span>()</span><br><span class="line">        losses_pts = self.forward_pts_train(img_feats, gt_bboxes_3d,</span><br><span class="line">                                            gt_labels_3d, img_metas,</span><br><span class="line">                                            gt_bboxes_ignore)</span><br><span class="line">        losses.update(losses_pts)</span><br><span class="line">        <span class="keyword">return</span> losses</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">forward_test</span>(<span class="params">self, points=<span class="literal">None</span>, img_metas=<span class="literal">None</span>, img_inputs=<span class="literal">None</span>, **kwargs</span>):</span><br><span class="line">        <span class="keyword">for</span> var, name <span class="keyword">in</span> [(img_inputs, <span class="string">&#x27;img_inputs&#x27;</span>), (img_metas, <span class="string">&#x27;img_metas&#x27;</span>)]:</span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> <span class="built_in">isinstance</span>(var, <span class="built_in">list</span>):</span><br><span class="line">                <span class="keyword">raise</span> TypeError(<span class="string">&#x27;&#123;&#125; must be a list, but got &#123;&#125;&#x27;</span>.<span class="built_in">format</span>(</span><br><span class="line">                    name, <span class="built_in">type</span>(var)))</span><br><span class="line"></span><br><span class="line">        num_augs = <span class="built_in">len</span>(img_inputs)</span><br><span class="line">        <span class="keyword">if</span> num_augs != <span class="built_in">len</span>(img_metas):</span><br><span class="line">            <span class="keyword">raise</span> ValueError(</span><br><span class="line">                <span class="string">&#x27;num of augmentations (&#123;&#125;) != num of image meta (&#123;&#125;)&#x27;</span>.<span class="built_in">format</span>(</span><br><span class="line">                    <span class="built_in">len</span>(img_inputs), <span class="built_in">len</span>(img_metas)))</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> <span class="built_in">isinstance</span>(img_inputs[<span class="number">0</span>][<span class="number">0</span>], <span class="built_in">list</span>):</span><br><span class="line">            img_inputs = [img_inputs] <span class="keyword">if</span> img_inputs <span class="keyword">is</span> <span class="literal">None</span> <span class="keyword">else</span> img_inputs</span><br><span class="line">            points = [points] <span class="keyword">if</span> points <span class="keyword">is</span> <span class="literal">None</span> <span class="keyword">else</span> points</span><br><span class="line">            <span class="keyword">return</span> self.simple_test(points[<span class="number">0</span>], img_metas[<span class="number">0</span>], img_inputs[<span class="number">0</span>], **kwargs)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">return</span> self.aug_test(<span class="literal">None</span>, img_metas[<span class="number">0</span>], img_inputs[<span class="number">0</span>], **kwargs)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">simple_test</span>(<span class="params">self, points, img_metas, img=<span class="literal">None</span>, rescale=<span class="literal">False</span></span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;Test function without augmentaiton.&quot;&quot;&quot;</span></span><br><span class="line">        img_feats, _ = self.extract_feat(points, img=img, img_metas=img_metas)</span><br><span class="line">        bbox_list = [<span class="built_in">dict</span>() <span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(img_metas))]</span><br><span class="line">        bbox_pts = self.simple_test_pts(img_feats, img_metas, rescale=rescale)</span><br><span class="line">        <span class="keyword">for</span> result_dict, pts_bbox <span class="keyword">in</span> <span class="built_in">zip</span>(bbox_list, bbox_pts):</span><br><span class="line">            result_dict[<span class="string">&#x27;pts_bbox&#x27;</span>] = pts_bbox</span><br><span class="line">        <span class="keyword">return</span> bbox_list</span><br></pre></td></tr></table></figure>

<h4 id="BackBone"><a href="#BackBone" class="headerlink" title="BackBone"></a>BackBone</h4><p>BackBone通常是用于提取图像特征的骨干网络，一般是指定已内置的网络直接调用，包括_<strong>ResNET</strong>_、**<em>SECOND</em><strong>、</strong><em>DLANet</em>**等。对于BEVDET-sttiny，其img_backbone的type为“SwinTransformer”、img_bev_encoder_backbone的type为“ResNetForBEVDet”，后者的具体定义如下</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> torch <span class="keyword">import</span> nn</span><br><span class="line"><span class="keyword">from</span> mmdet.models.backbones.resnet <span class="keyword">import</span> Bottleneck, BasicBlock</span><br><span class="line"><span class="keyword">import</span> torch.utils.checkpoint <span class="keyword">as</span> checkpoint</span><br><span class="line"><span class="keyword">from</span> mmdet.models <span class="keyword">import</span> BACKBONES</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@BACKBONES.register_module()</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ResNetForBEVDet</span>(nn.Module):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, numC_input, num_layer=[<span class="number">2</span>,<span class="number">2</span>,<span class="number">2</span>], num_channels=<span class="literal">None</span>, stride=[<span class="number">2</span>,<span class="number">2</span>,<span class="number">2</span>],</span></span><br><span class="line"><span class="params">                 backbone_output_ids=<span class="literal">None</span>, norm_cfg=<span class="built_in">dict</span>(<span class="params"><span class="built_in">type</span>=<span class="string">&#x27;BN&#x27;</span></span>),</span></span><br><span class="line"><span class="params">                 with_cp=<span class="literal">False</span>, block_type=<span class="string">&#x27;Basic&#x27;</span>,</span>):</span><br><span class="line">        <span class="built_in">super</span>(ResNetForBEVDet, self).__init__()</span><br><span class="line">        <span class="keyword">assert</span> <span class="built_in">len</span>(num_layer)==<span class="built_in">len</span>(stride)</span><br><span class="line">        num_channels = [numC_input*<span class="number">2</span>**(i+<span class="number">1</span>) <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(num_layer))] \</span><br><span class="line">            <span class="keyword">if</span> num_channels <span class="keyword">is</span> <span class="literal">None</span> <span class="keyword">else</span> num_channels</span><br><span class="line">        self.backbone_output_ids = <span class="built_in">range</span>(<span class="built_in">len</span>(num_layer)) \</span><br><span class="line">            <span class="keyword">if</span> backbone_output_ids <span class="keyword">is</span> <span class="literal">None</span> <span class="keyword">else</span> backbone_output_ids</span><br><span class="line">        layers = []</span><br><span class="line">        <span class="keyword">if</span> block_type == <span class="string">&#x27;BottleNeck&#x27;</span>:</span><br><span class="line">            curr_numC = numC_input</span><br><span class="line">            <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(num_layer)):</span><br><span class="line">                layer=[Bottleneck(curr_numC, num_channels[i]//<span class="number">4</span>, stride=stride[i],</span><br><span class="line">                                  downsample=nn.Conv2d(curr_numC,num_channels[i],<span class="number">3</span>,stride[i],<span class="number">1</span>),</span><br><span class="line">                                  norm_cfg=norm_cfg)]</span><br><span class="line">                curr_numC= num_channels[i]</span><br><span class="line">                layer.extend([Bottleneck(curr_numC, curr_numC//<span class="number">4</span>,</span><br><span class="line">                                         norm_cfg=norm_cfg) <span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(num_layer[i]-<span class="number">1</span>)])</span><br><span class="line">                layers.append(nn.Sequential(*layer))</span><br><span class="line">        <span class="keyword">elif</span> block_type == <span class="string">&#x27;Basic&#x27;</span>:</span><br><span class="line">            curr_numC = numC_input</span><br><span class="line">            <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(num_layer)):</span><br><span class="line">                layer=[BasicBlock(curr_numC, num_channels[i], stride=stride[i],</span><br><span class="line">                                  downsample=nn.Conv2d(curr_numC,num_channels[i],<span class="number">3</span>,stride[i],<span class="number">1</span>),</span><br><span class="line">                                  norm_cfg=norm_cfg)]</span><br><span class="line">                curr_numC= num_channels[i]</span><br><span class="line">                layer.extend([BasicBlock(curr_numC, curr_numC, norm_cfg=norm_cfg) <span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(num_layer[i]-<span class="number">1</span>)])</span><br><span class="line">                layers.append(nn.Sequential(*layer))</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">assert</span> <span class="literal">False</span></span><br><span class="line">        self.layers = nn.Sequential(*layers)</span><br><span class="line">        self.with_cp = with_cp</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">forward</span>(<span class="params">self, x</span>):</span><br><span class="line">        feats = []</span><br><span class="line">        x_tmp = x</span><br><span class="line">        <span class="keyword">for</span> lid, layer <span class="keyword">in</span> <span class="built_in">enumerate</span>(self.layers):</span><br><span class="line">            <span class="keyword">if</span> self.with_cp:</span><br><span class="line">                x_tmp = checkpoint.checkpoint(layer, x_tmp)</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                x_tmp = layer(x_tmp)</span><br><span class="line">            <span class="keyword">if</span> lid <span class="keyword">in</span> self.backbone_output_ids:</span><br><span class="line">                feats.append(x_tmp)</span><br><span class="line">        <span class="keyword">return</span> feats</span><br></pre></td></tr></table></figure>

<h4 id="Neck"><a href="#Neck" class="headerlink" title="Neck"></a>Neck</h4><p>Neck一般是FPN，用于增强模型对不同scale的目标的处理能力，一般是指定已内置的网络直接调用，包括**_ FPN_** 、**<em>SECONDFPN</em>**等。对于BEVDET-sttiny，其img_neck和img_bev_encoder_neck的type均为“FPN_LSS”，具体定义如下</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> torch</span><br><span class="line"><span class="keyword">import</span> torch.nn <span class="keyword">as</span> nn</span><br><span class="line"><span class="keyword">from</span> mmcv.cnn <span class="keyword">import</span> build_norm_layer</span><br><span class="line"><span class="keyword">from</span> mmdet.models <span class="keyword">import</span> NECKS</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@NECKS.register_module()</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">FPN_LSS</span>(nn.Module):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, in_channels, out_channels, scale_factor=<span class="number">4</span>,</span></span><br><span class="line"><span class="params">                 input_feature_index=(<span class="params"><span class="number">0</span>, <span class="number">2</span></span>),</span></span><br><span class="line"><span class="params">                 norm_cfg=<span class="built_in">dict</span>(<span class="params"><span class="built_in">type</span>=<span class="string">&#x27;BN&#x27;</span></span>),</span></span><br><span class="line"><span class="params">                 extra_upsample=<span class="number">2</span>,</span></span><br><span class="line"><span class="params">                 lateral=<span class="literal">None</span></span>):</span><br><span class="line">        <span class="built_in">super</span>().__init__()</span><br><span class="line">        self.input_feature_index = input_feature_index</span><br><span class="line">        self.extra_upsample = extra_upsample <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span></span><br><span class="line">        self.up = nn.Upsample(scale_factor=scale_factor, mode=<span class="string">&#x27;bilinear&#x27;</span>, align_corners=<span class="literal">True</span>)</span><br><span class="line">        channels_factor = <span class="number">2</span> <span class="keyword">if</span> self.extra_upsample <span class="keyword">else</span> <span class="number">1</span></span><br><span class="line">        self.conv = nn.Sequential(</span><br><span class="line">            nn.Conv2d(in_channels, out_channels * channels_factor, kernel_size=<span class="number">3</span>, padding=<span class="number">1</span>, bias=<span class="literal">False</span>),</span><br><span class="line">            build_norm_layer(norm_cfg, out_channels * channels_factor, postfix=<span class="number">0</span>)[<span class="number">1</span>],</span><br><span class="line">            nn.ReLU(inplace=<span class="literal">True</span>),</span><br><span class="line">            nn.Conv2d(out_channels * channels_factor, out_channels * channels_factor,</span><br><span class="line">                      kernel_size=<span class="number">3</span>, padding=<span class="number">1</span>, bias=<span class="literal">False</span>),</span><br><span class="line">            build_norm_layer(norm_cfg, out_channels * channels_factor, postfix=<span class="number">0</span>)[<span class="number">1</span>],</span><br><span class="line">            nn.ReLU(inplace=<span class="literal">True</span>),</span><br><span class="line">        )</span><br><span class="line">        <span class="keyword">if</span> self.extra_upsample:</span><br><span class="line">            self.up2 = nn.Sequential(</span><br><span class="line">                nn.Upsample(scale_factor=extra_upsample , mode=<span class="string">&#x27;bilinear&#x27;</span>, align_corners=<span class="literal">True</span>),</span><br><span class="line">                nn.Conv2d(out_channels * channels_factor, out_channels, kernel_size=<span class="number">3</span>, padding=<span class="number">1</span>, bias=<span class="literal">False</span>),</span><br><span class="line">                build_norm_layer(norm_cfg, out_channels, postfix=<span class="number">0</span>)[<span class="number">1</span>],</span><br><span class="line">                nn.ReLU(inplace=<span class="literal">True</span>),</span><br><span class="line">                nn.Conv2d(out_channels, out_channels, kernel_size=<span class="number">1</span>, padding=<span class="number">0</span>),</span><br><span class="line">            )</span><br><span class="line">        self.lateral=  lateral <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span></span><br><span class="line">        <span class="keyword">if</span> self.lateral:</span><br><span class="line">            self.lateral_conv = nn.Sequential(</span><br><span class="line">                nn.Conv2d(lateral, lateral,</span><br><span class="line">                          kernel_size=<span class="number">1</span>, padding=<span class="number">0</span>, bias=<span class="literal">False</span>),</span><br><span class="line">                build_norm_layer(norm_cfg, lateral, postfix=<span class="number">0</span>)[<span class="number">1</span>],</span><br><span class="line">                nn.ReLU(inplace=<span class="literal">True</span>),</span><br><span class="line">        )</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">forward</span>(<span class="params">self, feats</span>):</span><br><span class="line">        x2, x1 = feats[self.input_feature_index[<span class="number">0</span>]], feats[self.input_feature_index[<span class="number">1</span>]]</span><br><span class="line">        <span class="keyword">if</span> self.lateral:</span><br><span class="line">            x2 = self.lateral_conv(x2)</span><br><span class="line">        x1 = self.up(x1)</span><br><span class="line">        x1 = torch.cat([x2, x1], dim=<span class="number">1</span>)</span><br><span class="line">        x = self.conv(x1)</span><br><span class="line">        <span class="keyword">if</span> self.extra_upsample:</span><br><span class="line">            x = self.up2(x)</span><br><span class="line">        <span class="keyword">return</span> x</span><br></pre></td></tr></table></figure>

<h4 id="Head"><a href="#Head" class="headerlink" title="Head"></a>Head</h4><p>Head通常用于完成特定任务，loss函数和真值数据的处理也通常在这里完成，是稍微复杂一些的模块。MMDet3D已经提供的模块包括**<em>FCOSMono3DHead</em>** 、**<em>CenterHead</em>**等，对于任务相近的模型，可以选择直接继承这些任务增加一些自定义的函数，也可以直接继承Head的基类实现。对于BEVDET-sttiny，其pts_bbox_head的type为“CenterHeadBEVDet”，具体定义如下</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> copy</span><br><span class="line"><span class="keyword">import</span> torch</span><br><span class="line"><span class="keyword">from</span> mmcv.cnn <span class="keyword">import</span> ConvModule, build_conv_layer</span><br><span class="line"><span class="keyword">from</span> mmcv.runner <span class="keyword">import</span> BaseModule, force_fp32</span><br><span class="line"><span class="keyword">from</span> torch <span class="keyword">import</span> nn</span><br><span class="line"><span class="keyword">from</span> mmdet3d.core <span class="keyword">import</span> (circle_nms, draw_heatmap_gaussian, gaussian_radius, xywhr2xyxyr)</span><br><span class="line"><span class="keyword">from</span> mmdet3d.core.post_processing <span class="keyword">import</span> nms_bev</span><br><span class="line"><span class="keyword">from</span> mmdet3d.models <span class="keyword">import</span> builder</span><br><span class="line"><span class="keyword">from</span> mmdet3d.models.utils <span class="keyword">import</span> clip_sigmoid</span><br><span class="line"><span class="keyword">from</span> mmdet.core <span class="keyword">import</span> build_bbox_coder, multi_apply</span><br><span class="line"><span class="keyword">from</span> ..builder <span class="keyword">import</span> HEADS, build_loss</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@HEADS.register_module()</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">CenterHeadBEVDet</span>(<span class="title class_ inherited__">BaseModule</span>):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self,</span></span><br><span class="line"><span class="params">                 in_channels=[<span class="number">128</span>],</span></span><br><span class="line"><span class="params">                 tasks=<span class="literal">None</span>,</span></span><br><span class="line"><span class="params">                 train_cfg=<span class="literal">None</span>,</span></span><br><span class="line"><span class="params">                 test_cfg=<span class="literal">None</span>,</span></span><br><span class="line"><span class="params">                 bbox_coder=<span class="literal">None</span>,</span></span><br><span class="line"><span class="params">                 loss_cls=<span class="built_in">dict</span>(<span class="params"><span class="built_in">type</span>=<span class="string">&#x27;GaussianFocalLoss&#x27;</span>, reduction=<span class="string">&#x27;mean&#x27;</span></span>),</span></span><br><span class="line"><span class="params">                 loss_bbox=<span class="built_in">dict</span>(<span class="params"></span></span></span><br><span class="line"><span class="params"><span class="params">                     <span class="built_in">type</span>=<span class="string">&#x27;L1Loss&#x27;</span>, reduction=<span class="string">&#x27;none&#x27;</span>, loss_weight=<span class="number">0.25</span></span>),</span></span><br><span class="line"><span class="params">                 separate_head=<span class="built_in">dict</span>(<span class="params"></span></span></span><br><span class="line"><span class="params"><span class="params">                     <span class="built_in">type</span>=<span class="string">&#x27;SeparateHead&#x27;</span>, init_bias=-<span class="number">2.19</span>, final_kernel=<span class="number">3</span></span>),</span></span><br><span class="line"><span class="params">                 </span>):</span><br><span class="line">        <span class="keyword">assert</span> init_cfg <span class="keyword">is</span> <span class="literal">None</span>, <span class="string">&#x27;To prevent abnormal initialization &#x27;</span> \</span><br><span class="line">            <span class="string">&#x27;behavior, init_cfg is not allowed to be set&#x27;</span></span><br><span class="line">        <span class="built_in">super</span>(CenterHeadBEVDet, self).__init__(init_cfg=init_cfg)</span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">forward_single</span>(<span class="params">self, x</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;Forward function for CenterPoint.&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">forward</span>(<span class="params">self, feats</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;Forward pass.&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">return</span> multi_apply(self.forward_single, feats)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_gather_feat</span>(<span class="params">self, feat, ind, mask=<span class="literal">None</span></span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;Gather feature map&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">get_targets</span>(<span class="params">self, gt_bboxes_3d, gt_labels_3d</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;Generate targets&quot;&quot;&quot;</span></span><br><span class="line">        heatmaps, anno_boxes, inds, masks = multi_apply(</span><br><span class="line">            self.get_targets_single, gt_bboxes_3d, gt_labels_3d)</span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">get_targets_single</span>(<span class="params">self, gt_bboxes_3d, gt_labels_3d</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;Generate training targets for a single sample&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"><span class="meta">    @force_fp32(<span class="params">apply_to=(<span class="params"><span class="string">&#x27;preds_dicts&#x27;</span></span>)</span>)</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">loss</span>(<span class="params">self, gt_bboxes_3d, gt_labels_3d, preds_dicts, **kwargs</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;Loss function for CenterHead&quot;&quot;&quot;</span></span><br><span class="line">        heatmaps, anno_boxes, inds, masks = self.get_targets(</span><br><span class="line">            gt_bboxes_3d, gt_labels_3d)</span><br><span class="line">        loss_dict = <span class="built_in">dict</span>()</span><br><span class="line">        <span class="keyword">for</span> task_id, preds_dict <span class="keyword">in</span> <span class="built_in">enumerate</span>(preds_dicts):</span><br><span class="line">            <span class="comment"># heatmap focal loss</span></span><br><span class="line">            preds_dict[<span class="number">0</span>][<span class="string">&#x27;heatmap&#x27;</span>] = clip_sigmoid(preds_dict[<span class="number">0</span>][<span class="string">&#x27;heatmap&#x27;</span>])</span><br><span class="line">            num_pos = heatmaps[task_id].eq(<span class="number">1</span>).<span class="built_in">float</span>().<span class="built_in">sum</span>().item()</span><br><span class="line">            loss_heatmap = self.loss_cls(</span><br><span class="line">                preds_dict[<span class="number">0</span>][<span class="string">&#x27;heatmap&#x27;</span>],</span><br><span class="line">                heatmaps[task_id],</span><br><span class="line">                avg_factor=<span class="built_in">max</span>(num_pos, <span class="number">1</span>))</span><br><span class="line">            target_box = anno_boxes[task_id]</span><br><span class="line">            preds_dict[<span class="number">0</span>][<span class="string">&#x27;anno_box&#x27;</span>] = torch.cat(</span><br><span class="line">                (preds_dict[<span class="number">0</span>][<span class="string">&#x27;reg&#x27;</span>], preds_dict[<span class="number">0</span>][<span class="string">&#x27;height&#x27;</span>],</span><br><span class="line">                 preds_dict[<span class="number">0</span>][<span class="string">&#x27;dim&#x27;</span>], preds_dict[<span class="number">0</span>][<span class="string">&#x27;rot&#x27;</span>],</span><br><span class="line">                 preds_dict[<span class="number">0</span>][<span class="string">&#x27;vel&#x27;</span>]),</span><br><span class="line">                dim=<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">            ind = inds[task_id]</span><br><span class="line">            num = masks[task_id].<span class="built_in">float</span>().<span class="built_in">sum</span>()</span><br><span class="line">            pred = preds_dict[<span class="number">0</span>][<span class="string">&#x27;anno_box&#x27;</span>].permute(<span class="number">0</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">1</span>).contiguous()</span><br><span class="line">            pred = pred.view(pred.size(<span class="number">0</span>), -<span class="number">1</span>, pred.size(<span class="number">3</span>))</span><br><span class="line">            pred = self._gather_feat(pred, ind)</span><br><span class="line">            mask = masks[task_id].unsqueeze(<span class="number">2</span>).expand_as(target_box).<span class="built_in">float</span>()</span><br><span class="line">            isnotnan = (~torch.isnan(target_box)).<span class="built_in">float</span>()</span><br><span class="line">            mask *= isnotnan</span><br><span class="line"></span><br><span class="line">            code_weights = self.train_cfg.get(<span class="string">&#x27;code_weights&#x27;</span>, <span class="literal">None</span>)</span><br><span class="line">            bbox_weights = mask * mask.new_tensor(code_weights)</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> self.task_specific:</span><br><span class="line">                name_list = [<span class="string">&#x27;xy&#x27;</span>, <span class="string">&#x27;z&#x27;</span>, <span class="string">&#x27;whl&#x27;</span>, <span class="string">&#x27;yaw&#x27;</span>, <span class="string">&#x27;vel&#x27;</span>]</span><br><span class="line">                clip_index = [<span class="number">0</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">6</span>, <span class="number">8</span>, <span class="number">10</span>]</span><br><span class="line">                <span class="keyword">for</span> reg_task_id <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(name_list)):</span><br><span class="line">                    pred_tmp = pred[..., clip_index[reg_task_id]:clip_index[reg_task_id + <span class="number">1</span>]]</span><br><span class="line">                    target_box_tmp = target_box[..., clip_index[reg_task_id]:clip_index[reg_task_id + <span class="number">1</span>]]</span><br><span class="line">                    bbox_weights_tmp = bbox_weights[..., clip_index[reg_task_id]:clip_index[reg_task_id + <span class="number">1</span>]]</span><br><span class="line">                    loss_bbox_tmp = self.loss_bbox(</span><br><span class="line">                        pred_tmp, target_box_tmp, bbox_weights_tmp, avg_factor=(num + <span class="number">1e-4</span>))</span><br><span class="line">                    loss_dict[<span class="string">f&#x27;%stask<span class="subst">&#123;task_id&#125;</span>.loss_%s&#x27;</span> % (self.loss_prefix, name_list[reg_task_id])] = loss_bbox_tmp</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                loss_bbox = self.loss_bbox(</span><br><span class="line">                    pred, target_box, bbox_weights, avg_factor=(num + <span class="number">1e-4</span>))</span><br><span class="line">                loss_dict[<span class="string">f&#x27;task<span class="subst">&#123;task_id&#125;</span>.loss_bbox&#x27;</span>] = loss_bbox</span><br><span class="line"></span><br><span class="line">            loss_dict[<span class="string">f&#x27;%stask<span class="subst">&#123;task_id&#125;</span>.loss_heatmap&#x27;</span> % (self.loss_prefix)] = loss_heatmap</span><br><span class="line">        <span class="keyword">return</span> loss_dict</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">get_bboxes</span>(<span class="params">self, preds_dicts, img_metas, img=<span class="literal">None</span>, rescale=<span class="literal">False</span></span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;Generate bboxes from bbox head predictions&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">get_task_detections</span>(<span class="params">self, num_class_with_bg, batch_cls_preds,</span></span><br><span class="line"><span class="params">                            batch_reg_preds, batch_cls_labels, img_metas, task_id</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;Rotate nms for each task&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="新增自定义模型组件"><a href="#新增自定义模型组件" class="headerlink" title="新增自定义模型组件"></a>新增自定义模型组件</h4><p>此处以新增BackBone为例介绍如何新增自定义模型组件，其他组件的方法类似。<br>创建一个新文件mmdet3d&#x2F;models&#x2F;backbones&#x2F;second.py</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> torch.nn <span class="keyword">as</span> nn</span><br><span class="line"><span class="keyword">from</span> ..builder <span class="keyword">import</span> BACKBONES</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@BACKBONES.register_module()</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">SECOND</span>(<span class="title class_ inherited__">BaseModule</span>):</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, arg1, arg2</span>):</span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">forward</span>(<span class="params">self, x</span>):  <span class="comment"># should return a tuple</span></span><br><span class="line">        <span class="keyword">pass</span></span><br></pre></td></tr></table></figure>

<p>在&#x2F;mmdet3d&#x2F;models&#x2F;backbones&#x2F;<strong>init</strong>.py中导入该新增模块</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> .second <span class="keyword">import</span> SECOND</span><br></pre></td></tr></table></figure>

<p>在配置文件中使用新增的BackBone</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">model = <span class="built_in">dict</span>(</span><br><span class="line">    ...</span><br><span class="line">    backbone=<span class="built_in">dict</span>(</span><br><span class="line">        <span class="built_in">type</span>=<span class="string">&#x27;SECOND&#x27;</span>,</span><br><span class="line">        arg1=xxx,</span><br><span class="line">        arg2=xxx),</span><br><span class="line">    ...</span><br></pre></td></tr></table></figure>

      
    </div>

  </div>

  <div class="article-footer">
    <div class="article-meta pull-left">

    
      

    <span class="post-categories">
      <i class="icon-categories"></i>
        <a href="/categories/Code/">Code</a>
    </span>
    

    
    

    <span class="post-tags">
      <i class="icon-tags"></i>
        <a href="/tags/Multi-view-3D/">Multi-view 3D</a>
    </span>
    

    </div>

    
  </div>
</article>

  









    </main>

    <footer class="site-footer">
  <p class="site-info">
    Proudly powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and
    Theme by <a href="https://github.com/CodeDaraW/Hacker" target="_blank">Hacker</a>
    </br>
    
    &copy; 2023 Jingyi Yu
    
  </p>
</footer>
    
    
  </div>
</div>
</body>
</html>