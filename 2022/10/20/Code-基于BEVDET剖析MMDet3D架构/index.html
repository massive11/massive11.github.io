<!DOCTYPE HTML>
<html lang="en">


<head>
    <meta charset="utf-8">
    <meta name="keywords" content="基于BEVDET剖析MMDet3D框架, Untitled.">
    <meta name="description" content="本文基于BEVDET对MMDet3D框架进行了介绍


0.MMDetection3D简介MMDet3D 官方文档              MMDet3D官方仓库
选择MMDet3D的原因
MMDetection3D 支持**VoteNe">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="renderer" content="webkit|ie-stand|ie-comp">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="referrer" content="no-referrer-when-downgrade">
    <!-- Global site tag (gtag.js) - Google Analytics -->


    <title>基于BEVDET剖析MMDet3D框架 | Untitled.</title>
    <link rel="icon" type="image/png" href="/favicon.png">
    


    <!-- bg-cover style     -->



<link rel="stylesheet" type="text/css" href="/libs/awesome/css/all.min.css">
<link rel="stylesheet" type="text/css" href="/libs/materialize/materialize.min.css">
<link rel="stylesheet" type="text/css" href="/libs/aos/aos.css">
<link rel="stylesheet" type="text/css" href="/libs/animate/animate.min.css">
<link rel="stylesheet" type="text/css" href="/libs/lightGallery/css/lightgallery.min.css">
<link rel="stylesheet" type="text/css" href="/css/matery.css">
<link rel="stylesheet" type="text/css" href="/css/my.css">
<link rel="stylesheet" type="text/css" href="/css/dark.css" media="none" onload="if(media!='all')media='all'">




    <link rel="stylesheet" href="/libs/tocbot/tocbot.css">
    <link rel="stylesheet" href="/css/post.css">




    
        <link rel="stylesheet" type="text/css" href="/css/reward.css">
    



    <script src="/libs/jquery/jquery-3.6.0.min.js"></script>

<meta name="generator" content="Hexo 6.3.0"></head>


<body>
    <header class="navbar-fixed">
    <nav id="headNav" class="bg-color nav-transparent">
        <div id="navContainer" class="nav-wrapper container">
            <div class="brand-logo">
                <a href="/" class="waves-effect waves-light">
                    
                    <img src="/medias/logo.png" class="logo-img" alt="LOGO">
                    
                    <span class="logo-span">Untitled.</span>
                </a>
            </div>
            

<a href="#" data-target="mobile-nav" class="sidenav-trigger button-collapse"><i class="fas fa-bars"></i></a>
<ul class="right nav-menu">
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/" class="waves-effect waves-light">
      
      <i class="fas fa-home" style="zoom: 0.6;"></i>
      
      <span>Index</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/tags" class="waves-effect waves-light">
      
      <i class="fas fa-tags" style="zoom: 0.6;"></i>
      
      <span>Tags</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/categories" class="waves-effect waves-light">
      
      <i class="fas fa-bookmark" style="zoom: 0.6;"></i>
      
      <span>Categories</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/archives" class="waves-effect waves-light">
      
      <i class="fas fa-archive" style="zoom: 0.6;"></i>
      
      <span>Archives</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/about" class="waves-effect waves-light">
      
      <i class="fas fa-user-circle" style="zoom: 0.6;"></i>
      
      <span>About</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/contact" class="waves-effect waves-light">
      
      <i class="fas fa-comments" style="zoom: 0.6;"></i>
      
      <span>Contact</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/friends" class="waves-effect waves-light">
      
      <i class="fas fa-address-book" style="zoom: 0.6;"></i>
      
      <span>Friends</span>
    </a>
    
  </li>
  
  <li>
    <a href="#searchModal" class="modal-trigger waves-effect waves-light">
      <i id="searchIcon" class="fas fa-search" title="Search" style="zoom: 0.85;"></i>
    </a>
  </li>
  <li>
    <a href="javascript:;" class="waves-effect waves-light" onclick="switchNightMode()" title="深色/浅色模式" >
      <i id="sum-moon-icon" class="fas fa-sun" style="zoom: 0.85;"></i>
    </a>
  </li>
</ul>


<div id="mobile-nav" class="side-nav sidenav">

    <div class="mobile-head bg-color">
        
        <img src="/medias/logo.png" class="logo-img circle responsive-img">
        
        <div class="logo-name">Untitled.</div>
        <div class="logo-desc">
            
            Never really desperate, only the lost of the soul.
            
        </div>
    </div>

    <ul class="menu-list mobile-menu-list">
        
        <li class="m-nav-item">
	  
		<a href="/" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-home"></i>
			
			Index
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/tags" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-tags"></i>
			
			Tags
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/categories" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-bookmark"></i>
			
			Categories
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/archives" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-archive"></i>
			
			Archives
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/about" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-user-circle"></i>
			
			About
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/contact" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-comments"></i>
			
			Contact
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/friends" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-address-book"></i>
			
			Friends
		</a>
          
        </li>
        
        
        <li><div class="divider"></div></li>
        <li>
            <a href="https://github.com/blinkfox/hexo-theme-matery" class="waves-effect waves-light" target="_blank">
                <i class="fab fa-github-square fa-fw"></i>Fork Me
            </a>
        </li>
        
    </ul>
</div>


        </div>

        
            <style>
    .nav-transparent .github-corner {
        display: none !important;
    }

    .github-corner {
        position: absolute;
        z-index: 10;
        top: 0;
        right: 0;
        border: 0;
        transform: scale(1.1);
    }

    .github-corner svg {
        color: #0f9d58;
        fill: #fff;
        height: 64px;
        width: 64px;
    }

    .github-corner:hover .octo-arm {
        animation: a 0.56s ease-in-out;
    }

    .github-corner .octo-arm {
        animation: none;
    }

    @keyframes a {
        0%,
        to {
            transform: rotate(0);
        }
        20%,
        60% {
            transform: rotate(-25deg);
        }
        40%,
        80% {
            transform: rotate(10deg);
        }
    }
</style>

<a href="https://github.com/blinkfox/hexo-theme-matery" class="github-corner tooltipped hide-on-med-and-down" target="_blank"
   data-tooltip="Fork Me" data-position="left" data-delay="50">
    <svg viewBox="0 0 250 250" aria-hidden="true">
        <path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path>
        <path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2"
              fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path>
        <path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z"
              fill="currentColor" class="octo-body"></path>
    </svg>
</a>
        
    </nav>

</header>

    



<div class="bg-cover pd-header post-cover" style="background-image: url('/medias/featureimages/10.jpg')">
    <div class="container" style="right: 0px;left: 0px;">
        <div class="row">
            <div class="col s12 m12 l12">
                <div class="brand">
                    <h1 class="description center-align post-title">基于BEVDET剖析MMDet3D框架</h1>
                </div>
            </div>
        </div>
    </div>
</div>




<main class="post-container content">

    
    <div class="row">
    <div id="main-content" class="col s12 m12 l9">
        <!-- 文章内容详情 -->
<div id="artDetail">
    <div class="card">
        <div class="card-content article-info">
            <div class="row tag-cate">
                <div class="col s7">
                    
                    <div class="article-tag">
                        
                            <a href="/tags/Multi-view-3D/">
                                <span class="chip bg-color">Multi-view 3D</span>
                            </a>
                        
                    </div>
                    
                </div>
                <div class="col s5 right-align">
                    
                    <div class="post-cate">
                        <i class="fas fa-bookmark fa-fw icon-category"></i>
                        
                            <a href="/categories/Code/" class="post-category">
                                Code
                            </a>
                        
                    </div>
                    
                </div>
            </div>

            <div class="post-info">
                
                <div class="post-date info-break-policy">
                    <i class="far fa-calendar-minus fa-fw"></i>Publish Date:&nbsp;&nbsp;
                    2022-10-20
                </div>
                

                

                

                

                
            </div>
        </div>
        <hr class="clearfix">

        

        

        <div class="card-content article-card-content">
            <div id="articleContent">
                <p>本文基于BEVDET对MMDet3D框架进行了介绍</p>
<span id="more"></span>

<h1 id="0-MMDetection3D简介"><a href="#0-MMDetection3D简介" class="headerlink" title="0.MMDetection3D简介"></a>0.MMDetection3D简介</h1><p><a target="_blank" rel="noopener" href="https://mmdetection3d.readthedocs.io/zh_CN/latest/">MMDet3D 官方文档</a>             <a target="_blank" rel="noopener" href="https://github.com/open-mmlab/mmdetection3d"> MMDet3D官方仓库</a></p>
<h2 id="选择MMDet3D的原因"><a href="#选择MMDet3D的原因" class="headerlink" title="选择MMDet3D的原因"></a>选择MMDet3D的原因</h2><ol>
<li>MMDetection3D 支持**<em>VoteNet</em><strong>,</strong>_ MVXNe__t_<strong>，</strong><em>PointPillars</em>**等多种算法，覆盖了单模态和多模态检测，室内和室外场景SOTA; 还可以直接使用训练MMDetection里面的所有300+模型和40+算法，支持算法的数量和覆盖方向为3D检测代码库之最。</li>
<li>MMDetection3D 支持**<em>SUN RGB-D</em>**, <strong><em>ScanNet</em></strong>, <strong><em>nuScenes</em></strong>, **<em>Lyft</em><strong>和</strong><em>KITTI</em>**共5个主流数据集，支持的数据集数量为3D检测代码库之最。</li>
<li>MMDetection3D 拥有最快的训练速度，支持pip install一键安装，简单易用。</li>
</ol>
<h1 id="1-BEVDET网络框架"><a href="#1-BEVDET网络框架" class="headerlink" title="1.BEVDET网络框架"></a>1.BEVDET网络框架</h1><p><img src="https://cdn.nlark.com/yuque/0/2022/png/478741/1666948035924-74c5970b-6112-4723-b1f9-46e3e0111e0d.png#clientId=u97f915e7-6927-4&crop=0&crop=0&crop=1&crop=1&from=drop&id=u6d0187ae&margin=%5Bobject%20Object%5D&name=%E6%88%AA%E5%B1%8F2022-10-28%2017.07.08.png&originHeight=932&originWidth=2192&originalType=binary&ratio=1&rotation=0&showTitle=false&size=1220852&status=done&style=none&taskId=u3c922d1d-7d73-4325-a0b7-ab7b0626dc0&title=#averageHue=%23d0d0cb&id=GmgFu&originHeight=932&originWidth=2192&originalType=binary&ratio=1&rotation=0&showTitle=false&status=done&style=none&title=" alt="截屏2022-10-28 17.07.08.png"><br>图1 BEVDET网络结构</p>
<h1 id="2-基于MMDet3D的BEVDET代码框架"><a href="#2-基于MMDet3D的BEVDET代码框架" class="headerlink" title="2.基于MMDet3D的BEVDET代码框架"></a>2.基于MMDet3D的BEVDET代码框架</h1><h2 id="2-1数据预处理"><a href="#2-1数据预处理" class="headerlink" title="2.1数据预处理"></a>2.1数据预处理</h2><h3 id="2-1-1-数据集定义"><a href="#2-1-1-数据集定义" class="headerlink" title="2.1.1 数据集定义"></a>2.1.1 数据集定义</h3><p>MMDet3D支持**<em>SUN RGB-D</em>**, <strong><em>ScanNet</em></strong>, <strong><em>nuScenes</em></strong>, **<em>Lyft</em><strong>和</strong><em>KITTI</em>**共5个主流数据集。对于上述数据集之外的公开数据集或者自定义数据集，可以通过继承 Custom3DDataset 来实现新的数据集类，并重载相关的方法，如 BEVDETNuScenesDataset数据集所示，该文件位于&#x2F;mmdet3d&#x2F;datasets&#x2F;bevdet_nuscenes_dataset.py。<br>数据集类中主要提供加载标注数据、转换数据格式、验证模型结果、定义数据集处理流程等相关功能。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> mmcv</span><br><span class="line"><span class="keyword">import</span> torch</span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">import</span> tempfile</span><br><span class="line"><span class="keyword">from</span> nuscenes.utils.data_classes <span class="keyword">import</span> Box <span class="keyword">as</span> NuScenesBox</span><br><span class="line"><span class="keyword">from</span> os <span class="keyword">import</span> path <span class="keyword">as</span> osp</span><br><span class="line"><span class="keyword">from</span> mmdet.datasets <span class="keyword">import</span> DATASETS</span><br><span class="line"><span class="keyword">from</span> ..core <span class="keyword">import</span> show_result</span><br><span class="line"><span class="keyword">from</span> ..core.bbox <span class="keyword">import</span> Box3DMode, Coord3DMode, LiDARInstance3DBoxes</span><br><span class="line"><span class="keyword">from</span> .custom_3d <span class="keyword">import</span> Custom3DDataset</span><br><span class="line"><span class="keyword">from</span> .pipelines <span class="keyword">import</span> Compose</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@DATASETS.register_module()</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">BEVDETNuScenesDataset</span>(<span class="title class_ inherited__">Custom3DDataset</span>):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">load_annotations</span>(<span class="params">self, ann_file</span>):</span><br><span class="line">    	<span class="string">&quot;&quot;&quot;Load annotations from ann_file.&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_format_bbox</span>(<span class="params">self, results, jsonfile_prefix=<span class="literal">None</span></span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;Convert the results to the standard format.&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line">        </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">evaluate</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;Evaluation in BEVDETNuScenesDataset protocol.&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">format_results</span>(<span class="params">self, results, jsonfile_prefix=<span class="literal">None</span></span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;Format the results to json&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_build_default_pipeline</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;Build the default pipeline for this dataset.&quot;&quot;&quot;</span></span><br></pre></td></tr></table></figure>
<h4 id=""><a href="#" class="headerlink" title=""></a></h4><h4 id="新增自定义数据集"><a href="#新增自定义数据集" class="headerlink" title="新增自定义数据集"></a>新增自定义数据集</h4><p>在 &#x2F;mmdet3d&#x2F;datasets&#x2F;my_dataset.py 中创建一个新的数据集类来进行数据的加载，如下所示。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">from</span> os <span class="keyword">import</span> path <span class="keyword">as</span> osp</span><br><span class="line"><span class="keyword">from</span> mmdet3d.core <span class="keyword">import</span> show_result</span><br><span class="line"><span class="keyword">from</span> mmdet3d.core.bbox <span class="keyword">import</span> DepthInstance3DBoxes</span><br><span class="line"><span class="keyword">from</span> mmdet.datasets <span class="keyword">import</span> DATASETS</span><br><span class="line"><span class="keyword">from</span> .custom_3d <span class="keyword">import</span> Custom3DDataset</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@DATASETS.register_module()</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">MyDataset</span>(<span class="title class_ inherited__">Custom3DDataset</span>):</span><br><span class="line">    CLASSES = (<span class="string">&#x27;cabinet&#x27;</span>, <span class="string">&#x27;bed&#x27;</span>, <span class="string">&#x27;chair&#x27;</span>, <span class="string">&#x27;sofa&#x27;</span>, <span class="string">&#x27;table&#x27;</span>, <span class="string">&#x27;door&#x27;</span>, <span class="string">&#x27;window&#x27;</span>,</span><br><span class="line">               <span class="string">&#x27;bookshelf&#x27;</span>, <span class="string">&#x27;picture&#x27;</span>, <span class="string">&#x27;counter&#x27;</span>, <span class="string">&#x27;desk&#x27;</span>, <span class="string">&#x27;curtain&#x27;</span>,</span><br><span class="line">               <span class="string">&#x27;refrigerator&#x27;</span>, <span class="string">&#x27;showercurtrain&#x27;</span>, <span class="string">&#x27;toilet&#x27;</span>, <span class="string">&#x27;sink&#x27;</span>, <span class="string">&#x27;bathtub&#x27;</span>,</span><br><span class="line">               <span class="string">&#x27;garbagebin&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self,</span></span><br><span class="line"><span class="params">                 data_root,</span></span><br><span class="line"><span class="params">                 ann_file,</span></span><br><span class="line"><span class="params">                 pipeline=<span class="literal">None</span>,</span></span><br><span class="line"><span class="params">                 classes=<span class="literal">None</span>,</span></span><br><span class="line"><span class="params">                 modality=<span class="literal">None</span>,</span></span><br><span class="line"><span class="params">                 box_type_3d=<span class="string">&#x27;Depth&#x27;</span>,</span></span><br><span class="line"><span class="params">                 filter_empty_gt=<span class="literal">True</span>,</span></span><br><span class="line"><span class="params">                 test_mode=<span class="literal">False</span></span>):</span><br><span class="line">        <span class="built_in">super</span>().__init__(</span><br><span class="line">            data_root=data_root,</span><br><span class="line">            ann_file=ann_file,</span><br><span class="line">            pipeline=pipeline,</span><br><span class="line">            classes=classes,</span><br><span class="line">            modality=modality,</span><br><span class="line">            box_type_3d=box_type_3d,</span><br><span class="line">            filter_empty_gt=filter_empty_gt,</span><br><span class="line">            test_mode=test_mode)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">get_ann_info</span>(<span class="params">self, index</span>):</span><br><span class="line">        <span class="comment"># 通过下标来获取标注信息，evalhook 也能够通过此接口来获取标注信息</span></span><br><span class="line">        info = self.data_infos[index]</span><br><span class="line">        <span class="keyword">if</span> info[<span class="string">&#x27;annos&#x27;</span>][<span class="string">&#x27;gt_num&#x27;</span>] != <span class="number">0</span>:</span><br><span class="line">            gt_bboxes_3d = info[<span class="string">&#x27;annos&#x27;</span>][<span class="string">&#x27;gt_boxes_upright_depth&#x27;</span>].astype(</span><br><span class="line">                np.float32)  <span class="comment"># k, 6</span></span><br><span class="line">            gt_labels_3d = info[<span class="string">&#x27;annos&#x27;</span>][<span class="string">&#x27;class&#x27;</span>].astype(np.int64)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            gt_bboxes_3d = np.zeros((<span class="number">0</span>, <span class="number">6</span>), dtype=np.float32)</span><br><span class="line">            gt_labels_3d = np.zeros((<span class="number">0</span>, ), dtype=np.int64)</span><br><span class="line">        <span class="comment"># 转换为目标标注框的结构</span></span><br><span class="line">        gt_bboxes_3d = DepthInstance3DBoxes(</span><br><span class="line">            gt_bboxes_3d,</span><br><span class="line">            box_dim=gt_bboxes_3d.shape[-<span class="number">1</span>],</span><br><span class="line">            with_yaw=<span class="literal">False</span>,</span><br><span class="line">            origin=(<span class="number">0.5</span>, <span class="number">0.5</span>, <span class="number">0.5</span>)).convert_to(self.box_mode_3d)</span><br><span class="line">        pts_instance_mask_path = osp.join(self.data_root,</span><br><span class="line">                                          info[<span class="string">&#x27;pts_instance_mask_path&#x27;</span>])</span><br><span class="line">        pts_semantic_mask_path = osp.join(self.data_root,</span><br><span class="line">                                          info[<span class="string">&#x27;pts_semantic_mask_path&#x27;</span>])</span><br><span class="line">        anns_results = <span class="built_in">dict</span>(</span><br><span class="line">            gt_bboxes_3d=gt_bboxes_3d,</span><br><span class="line">            gt_labels_3d=gt_labels_3d,</span><br><span class="line">            pts_instance_mask_path=pts_instance_mask_path,</span><br><span class="line">            pts_semantic_mask_path=pts_semantic_mask_path)</span><br><span class="line">        <span class="keyword">return</span> anns_results</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>修改配置文件来调用 MyDataset 数据集类，如下所示。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">dataset_A_train = <span class="built_in">dict</span>(</span><br><span class="line">    <span class="built_in">type</span>=<span class="string">&#x27;MyDataset&#x27;</span>,</span><br><span class="line">    ann_file = <span class="string">&#x27;annotation.pkl&#x27;</span>,</span><br><span class="line">    pipeline=train_pipeline</span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<h3 id="2-1-2-数据预处理流程"><a href="#2-1-2-数据预处理流程" class="headerlink" title="2.1.2 数据预处理流程"></a>2.1.2 数据预处理流程</h3><p>数据预处理流程和数据集之间是互相分离的两个部分，通常数据集定义了如何处理标注信息，而数据预处理流程定义了准备数据项字典的所有步骤。数据集预处理流程包含一系列的操作，每个操作将一个字典作为输入，并输出应用于下一个转换的一个新的字典。<br>图2是一个最经典的数据集预处理流程，其中蓝色框表示预处理流程中的各项操作。随着预处理的进行，每一个操作都会添加新的键值（图中标记为绿色）到输出字典中，或者更新当前存在的键值（图中标记为橙色）。<br><img src="https://cdn.nlark.com/yuque/0/2022/png/478741/1667200896660-27698477-fb06-47c7-8031-229b959ac09b.png#clientId=u5a86381d-9405-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=318&id=u090dea26&margin=%5Bobject%20Object%5D&name=image.png&originHeight=398&originWidth=1788&originalType=binary&ratio=1&rotation=0&showTitle=false&size=340808&status=done&style=none&taskId=u893c5257-2ea9-44d0-9330-73e7395dac1&title=&width=1430.4#averageHue=%23faf9f9&id=kwdD0&originHeight=398&originWidth=1788&originalType=binary&ratio=1&rotation=0&showTitle=false&status=done&style=none&title=" alt="image.png"><br>图2 数据集预处理流程</p>
<p>预处理流程中的各项操作主要分为数据加载、预处理、格式化、测试时的数据增强。以BEVDET为例，我们对预处理流程中各项操作进行具体的分析。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">train_pipeline = [</span><br><span class="line">    <span class="built_in">dict</span>(<span class="built_in">type</span>=<span class="string">&#x27;LoadMultiViewImageFromFiles_BEVDet&#x27;</span>, is_train=<span class="literal">True</span>, data_config=data_config),</span><br><span class="line">    <span class="built_in">dict</span>(<span class="built_in">type</span>=<span class="string">&#x27;LoadPointsFromFile&#x27;</span>,</span><br><span class="line">        coord_type=<span class="string">&#x27;LIDAR&#x27;</span>,</span><br><span class="line">        load_dim=<span class="number">5</span>,</span><br><span class="line">        use_dim=<span class="number">5</span>,</span><br><span class="line">        file_client_args=file_client_args),</span><br><span class="line">    <span class="built_in">dict</span>(<span class="built_in">type</span>=<span class="string">&#x27;LoadAnnotations3D&#x27;</span>, with_bbox_3d=<span class="literal">True</span>, with_label_3d=<span class="literal">True</span>),</span><br><span class="line">    <span class="built_in">dict</span>(<span class="built_in">type</span>=<span class="string">&#x27;GlobalRotScaleTrans&#x27;</span>,</span><br><span class="line">        rot_range=[-<span class="number">0.3925</span>, <span class="number">0.3925</span>],</span><br><span class="line">        scale_ratio_range=[<span class="number">0.95</span>, <span class="number">1.05</span>],</span><br><span class="line">        translation_std=[<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>],</span><br><span class="line">        update_img2lidar=<span class="literal">True</span>),</span><br><span class="line">    <span class="built_in">dict</span>(<span class="built_in">type</span>=<span class="string">&#x27;RandomFlip3D&#x27;</span>,</span><br><span class="line">        sync_2d=<span class="literal">False</span>,</span><br><span class="line">        flip_ratio_bev_horizontal=<span class="number">0.5</span>,</span><br><span class="line">        flip_ratio_bev_vertical=<span class="number">0.5</span>,</span><br><span class="line">        update_img2lidar=<span class="literal">True</span>),</span><br><span class="line">    <span class="built_in">dict</span>(<span class="built_in">type</span>=<span class="string">&#x27;ObjectRangeFilter&#x27;</span>, point_cloud_range=point_cloud_range),</span><br><span class="line">    <span class="built_in">dict</span>(<span class="built_in">type</span>=<span class="string">&#x27;ObjectNameFilter&#x27;</span>, classes=class_names),</span><br><span class="line">    <span class="built_in">dict</span>(<span class="built_in">type</span>=<span class="string">&#x27;DefaultFormatBundle3D&#x27;</span>, class_names=class_names),</span><br><span class="line">    <span class="built_in">dict</span>(<span class="built_in">type</span>=<span class="string">&#x27;Collect3D&#x27;</span>, keys=[<span class="string">&#x27;img_inputs&#x27;</span>, <span class="string">&#x27;gt_bboxes_3d&#x27;</span>, <span class="string">&#x27;gt_labels_3d&#x27;</span>],</span><br><span class="line">         meta_keys=(<span class="string">&#x27;filename&#x27;</span>, <span class="string">&#x27;ori_shape&#x27;</span>, <span class="string">&#x27;img_shape&#x27;</span>, <span class="string">&#x27;lidar2img&#x27;</span>,</span><br><span class="line">                            <span class="string">&#x27;depth2img&#x27;</span>, <span class="string">&#x27;cam2img&#x27;</span>, <span class="string">&#x27;pad_shape&#x27;</span>,</span><br><span class="line">                            <span class="string">&#x27;scale_factor&#x27;</span>, <span class="string">&#x27;flip&#x27;</span>, <span class="string">&#x27;pcd_horizontal_flip&#x27;</span>,</span><br><span class="line">                            <span class="string">&#x27;pcd_vertical_flip&#x27;</span>, <span class="string">&#x27;box_mode_3d&#x27;</span>, <span class="string">&#x27;box_type_3d&#x27;</span>,</span><br><span class="line">                            <span class="string">&#x27;img_norm_cfg&#x27;</span>, <span class="string">&#x27;pcd_trans&#x27;</span>, <span class="string">&#x27;sample_idx&#x27;</span>,</span><br><span class="line">                            <span class="string">&#x27;pcd_scale_factor&#x27;</span>, <span class="string">&#x27;pcd_rotation&#x27;</span>, <span class="string">&#x27;pts_filename&#x27;</span>,</span><br><span class="line">                            <span class="string">&#x27;transformation_3d_flow&#x27;</span>, <span class="string">&#x27;img_info&#x27;</span>))</span><br><span class="line">]</span><br></pre></td></tr></table></figure>

<p>上述流程中涉及到的各项操作及其在MMDet3D框架下的实际位置如表1所示。Collect3D最后返回的img_meta包含模型输入的全部数据。<br>表1 BEVDET相关数据处理操作</p>
<table>
<thead>
<tr>
<th>操作项</th>
<th>数据处理操作</th>
<th>功能</th>
<th>代码位置</th>
</tr>
</thead>
<tbody><tr>
<td>数据加载</td>
<td>LoadMultiViewImageFromFiles_BEVDet</td>
<td>加载六个相机的单帧图像，进行图像的缩放和裁剪操作等</td>
<td>&#x2F;mmdet3d&#x2F;datasets&#x2F;pipelines&#x2F;loading.py</td>
</tr>
<tr>
<td></td>
<td>LoadPointsFromFile</td>
<td>加载LiDAR点云（如果不需要点云数据可以不加载）</td>
<td></td>
</tr>
<tr>
<td></td>
<td>LoadAnnotations3D</td>
<td>加载标注数据</td>
<td></td>
</tr>
<tr>
<td>数据预处理</td>
<td>GlobalRotScaleTrans</td>
<td>对于点云数据的旋转、平移、缩放</td>
<td>&#x2F;mmdet3d&#x2F;datasets&#x2F;pipelines&#x2F;transforms_3d.py</td>
</tr>
<tr>
<td></td>
<td>RandomFlip3D</td>
<td>翻转点云和目标框</td>
<td></td>
</tr>
<tr>
<td></td>
<td>ObjectRangeFilter</td>
<td>根据范围过滤目标框</td>
<td></td>
</tr>
<tr>
<td></td>
<td>ObjectNameFilter</td>
<td>根据类别过滤目标框</td>
<td></td>
</tr>
<tr>
<td>格式化</td>
<td>DefaultFormatBundle3D</td>
<td>格式化真值数据</td>
<td>&#x2F;mmdet3d&#x2F;datasets&#x2F;pipelines&#x2F;formating.py</td>
</tr>
<tr>
<td></td>
<td>Collect3D</td>
<td>添加img_meta （由 meta_keys 指定的键值构成的 img_meta），移除所有除 keys 指定的键值以外的其他键值</td>
<td></td>
</tr>
</tbody></table>
<h4 id="新增自定义数据处理方法"><a href="#新增自定义数据处理方法" class="headerlink" title="新增自定义数据处理方法"></a>新增自定义数据处理方法</h4><p>在 &#x2F;mmdet3d&#x2F;datasets&#x2F;pipelines&#x2F;my_pipeline.py中写入新的数据集预处理方法，该预处理方法的输入和输出均为字典</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> mmdet.datasets <span class="keyword">import</span> PIPELINES</span><br><span class="line"></span><br><span class="line"><span class="meta">@PIPELINES.register_module()</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">MyTransform</span>:</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__call__</span>(<span class="params">self, results</span>):</span><br><span class="line">        results[<span class="string">&#x27;dummy&#x27;</span>] = <span class="literal">True</span></span><br><span class="line">        <span class="keyword">return</span> results</span><br></pre></td></tr></table></figure>

<p>在&#x2F;mmdet3d&#x2F;datasets&#x2F;pipelines&#x2F;<strong>init</strong>.py 中导入新的数据处理方法</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> .my_pipeline <span class="keyword">import</span> MyTransform</span><br></pre></td></tr></table></figure>

<p>在配置文件中使用该数据预处理方法</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">train_pipeline = [</span><br><span class="line">    <span class="built_in">dict</span>(</span><br><span class="line">        <span class="built_in">type</span>=<span class="string">&#x27;LoadPointsFromFile&#x27;</span>,</span><br><span class="line">        load_dim=<span class="number">5</span>,</span><br><span class="line">        use_dim=<span class="number">5</span>,</span><br><span class="line">        file_client_args=file_client_args),</span><br><span class="line">    <span class="string">&quot;&quot;&quot;...&quot;&quot;&quot;</span></span><br><span class="line">    <span class="built_in">dict</span>(<span class="built_in">type</span>=<span class="string">&#x27;MyTransform&#x27;</span>),</span><br><span class="line">    <span class="string">&quot;&quot;&quot;...&quot;&quot;&quot;</span></span><br><span class="line">    <span class="built_in">dict</span>(<span class="built_in">type</span>=<span class="string">&#x27;Collect3D&#x27;</span>, keys=[<span class="string">&#x27;points&#x27;</span>, <span class="string">&#x27;gt_bboxes_3d&#x27;</span>, <span class="string">&#x27;gt_labels_3d&#x27;</span>])</span><br><span class="line">]</span><br></pre></td></tr></table></figure>

<h2 id="2-2模型"><a href="#2-2模型" class="headerlink" title="2.2模型"></a>2.2模型</h2><h3 id="2-2-1-配置模型结构"><a href="#2-2-1-配置模型结构" class="headerlink" title="2.2.1 配置模型结构"></a>2.2.1 配置模型结构</h3><p>MMDet3D使用config文件配置模型结构，BEVDET-sttiny版本的模型配置部分如下</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line">model = <span class="built_in">dict</span>(<span class="built_in">type</span>=<span class="string">&#x27;BEVDet&#x27;</span>,</span><br><span class="line">    img_backbone=<span class="built_in">dict</span>(<span class="built_in">type</span>=<span class="string">&#x27;SwinTransformer&#x27;</span>,</span><br><span class="line">        pretrained=<span class="string">&#x27;https://github.com/SwinTransformer/storage/releases/download/v1.0.0/swin_tiny_patch4_window7_224.pth&#x27;</span>,</span><br><span class="line">        pretrain_img_size=<span class="number">224</span>,</span><br><span class="line">        embed_dims=<span class="number">96</span>,</span><br><span class="line">        patch_size=<span class="number">4</span>,</span><br><span class="line">        window_size=<span class="number">7</span>,</span><br><span class="line">        mlp_ratio=<span class="number">4</span>,</span><br><span class="line">        depths=[<span class="number">2</span>, <span class="number">2</span>, <span class="number">6</span>, <span class="number">2</span>],</span><br><span class="line">        num_heads=[<span class="number">3</span>, <span class="number">6</span>, <span class="number">12</span>, <span class="number">24</span>],</span><br><span class="line">        strides=(<span class="number">4</span>, <span class="number">2</span>, <span class="number">2</span>, <span class="number">2</span>),</span><br><span class="line">        out_indices=(<span class="number">2</span>, <span class="number">3</span>,),</span><br><span class="line">        qkv_bias=<span class="literal">True</span>,</span><br><span class="line">        qk_scale=<span class="literal">None</span>,</span><br><span class="line">        patch_norm=<span class="literal">True</span>,</span><br><span class="line">        drop_rate=<span class="number">0.</span>,</span><br><span class="line">        attn_drop_rate=<span class="number">0.</span>,</span><br><span class="line">        drop_path_rate=<span class="number">0.0</span>,</span><br><span class="line">        use_abs_pos_embed=<span class="literal">False</span>,</span><br><span class="line">        act_cfg=<span class="built_in">dict</span>(<span class="built_in">type</span>=<span class="string">&#x27;GELU&#x27;</span>),</span><br><span class="line">        norm_cfg=<span class="built_in">dict</span>(<span class="built_in">type</span>=<span class="string">&#x27;LN&#x27;</span>, requires_grad=<span class="literal">True</span>),</span><br><span class="line">        pretrain_style=<span class="string">&#x27;official&#x27;</span>,</span><br><span class="line">        output_missing_index_as_none=<span class="literal">False</span>),</span><br><span class="line">    img_neck=<span class="built_in">dict</span>(<span class="built_in">type</span>=<span class="string">&#x27;FPN_LSS&#x27;</span>,</span><br><span class="line">        in_channels=<span class="number">384</span>+<span class="number">768</span>,</span><br><span class="line">        out_channels=<span class="number">512</span>,</span><br><span class="line">        extra_upsample=<span class="literal">None</span>,</span><br><span class="line">        input_feature_index=(<span class="number">0</span>,<span class="number">1</span>),</span><br><span class="line">        scale_factor=<span class="number">2</span>),</span><br><span class="line">    img_view_transformer=<span class="built_in">dict</span>(<span class="built_in">type</span>=<span class="string">&#x27;ViewTransformerLiftSplatShoot&#x27;</span>, grid_config=grid_config, data_config=data_config, numC_Trans=numC_Trans),</span><br><span class="line">    img_bev_encoder_backbone = <span class="built_in">dict</span>(<span class="built_in">type</span>=<span class="string">&#x27;ResNetForBEVDet&#x27;</span>, numC_input=numC_Trans),</span><br><span class="line">    img_bev_encoder_neck = <span class="built_in">dict</span>(<span class="built_in">type</span>=<span class="string">&#x27;FPN_LSS&#x27;</span>, in_channels=numC_Trans*<span class="number">8</span>+numC_Trans*<span class="number">2</span>, out_channels=<span class="number">256</span>),</span><br><span class="line">    pts_bbox_head=<span class="built_in">dict</span>(<span class="built_in">type</span>=<span class="string">&#x27;CenterHeadBEVDet&#x27;</span>,</span><br><span class="line">        in_channels=<span class="number">256</span>,</span><br><span class="line">        tasks=[<span class="built_in">dict</span>(num_class=<span class="number">1</span>, class_names=[<span class="string">&#x27;car&#x27;</span>]),</span><br><span class="line">            <span class="built_in">dict</span>(num_class=<span class="number">2</span>, class_names=[<span class="string">&#x27;truck&#x27;</span>, <span class="string">&#x27;construction_vehicle&#x27;</span>]),</span><br><span class="line">            <span class="built_in">dict</span>(num_class=<span class="number">2</span>, class_names=[<span class="string">&#x27;bus&#x27;</span>, <span class="string">&#x27;trailer&#x27;</span>]),</span><br><span class="line">            <span class="built_in">dict</span>(num_class=<span class="number">1</span>, class_names=[<span class="string">&#x27;barrier&#x27;</span>]),</span><br><span class="line">            <span class="built_in">dict</span>(num_class=<span class="number">2</span>, class_names=[<span class="string">&#x27;motorcycle&#x27;</span>, <span class="string">&#x27;bicycle&#x27;</span>]),</span><br><span class="line">            <span class="built_in">dict</span>(num_class=<span class="number">2</span>, class_names=[<span class="string">&#x27;pedestrian&#x27;</span>, <span class="string">&#x27;traffic_cone&#x27;</span>]),</span><br><span class="line">        ],</span><br><span class="line">        common_heads=<span class="built_in">dict</span>(reg=(<span class="number">2</span>, <span class="number">2</span>), height=(<span class="number">1</span>, <span class="number">2</span>), dim=(<span class="number">3</span>, <span class="number">2</span>), rot=(<span class="number">2</span>, <span class="number">2</span>), vel=(<span class="number">2</span>, <span class="number">2</span>)),</span><br><span class="line">        share_conv_channel=<span class="number">64</span>,</span><br><span class="line">        bbox_coder=<span class="built_in">dict</span>(<span class="built_in">type</span>=<span class="string">&#x27;CenterPointBBoxCoder&#x27;</span>,</span><br><span class="line">            pc_range=point_cloud_range[:<span class="number">2</span>],</span><br><span class="line">            post_center_range=[-<span class="number">61.2</span>, -<span class="number">61.2</span>, -<span class="number">10.0</span>, <span class="number">61.2</span>, <span class="number">61.2</span>, <span class="number">10.0</span>],</span><br><span class="line">            max_num=<span class="number">500</span>,</span><br><span class="line">            score_threshold=<span class="number">0.1</span>,</span><br><span class="line">            out_size_factor=<span class="number">8</span>,</span><br><span class="line">            voxel_size=voxel_size[:<span class="number">2</span>],</span><br><span class="line">            code_size=<span class="number">9</span>),</span><br><span class="line">        separate_head=<span class="built_in">dict</span>(<span class="built_in">type</span>=<span class="string">&#x27;SeparateHead&#x27;</span>, init_bias=-<span class="number">2.19</span>, final_kernel=<span class="number">3</span>),</span><br><span class="line">        loss_cls=<span class="built_in">dict</span>(<span class="built_in">type</span>=<span class="string">&#x27;GaussianFocalLoss&#x27;</span>, reduction=<span class="string">&#x27;mean&#x27;</span>),</span><br><span class="line">        loss_bbox=<span class="built_in">dict</span>(<span class="built_in">type</span>=<span class="string">&#x27;L1Loss&#x27;</span>, reduction=<span class="string">&#x27;mean&#x27;</span>, loss_weight=<span class="number">0.25</span>),</span><br><span class="line">        norm_bbox=<span class="literal">True</span>),</span><br><span class="line">    )  <span class="comment"># 省略了模型的训练和配置信息</span></span><br></pre></td></tr></table></figure>


<p>上述模块划分与论文中的模块划分基本一致，其对应关系以及在MMDet3D框架下的实际位置如表2所示<br>表2  BEVDET的模型配置</p>
<table>
<thead>
<tr>
<th>论文模块</th>
<th>代码模块</th>
<th>Tensor Size</th>
<th>类型</th>
<th>代码位置</th>
<th>原论文</th>
</tr>
</thead>
<tbody><tr>
<td>Image-view Encoder</td>
<td>img_backbone</td>
<td>[B, N, 3, 256, 704]</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>$\downarrow$</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>[[B, N, 384, 16, 44],</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>[B, N, 768, 8, 22]]</td>
<td>SwinTransformer</td>
<td>mmdet3d&#x2F;models&#x2F;backbones&#x2F;swin.py</td>
<td>Swin Transformer: Hierarchical Vision Transformer using Shifted Windows</td>
<td></td>
<td></td>
</tr>
<tr>
<td></td>
<td>img_neck</td>
<td>[[B, N, 384, 16, 44],</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>[B, N, 768, 8, 22]]</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>$\downarrow$</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>[B, N, 512, 16, 44]</td>
<td>FPN_LSS</td>
<td>mmdet3d&#x2F;models&#x2F;necks&#x2F;lss_fpn.py</td>
<td>Feature Pyramid Networks for Object Detection</td>
<td></td>
<td></td>
</tr>
<tr>
<td>View Transformer</td>
<td>img_view_transformer</td>
<td>[B, N, 512, 16, 44]</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>$\downarrow$</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>[B, 64, 128, 128]</td>
<td>ViewTransformerLSS</td>
<td>mmdet3d&#x2F;models&#x2F;necks&#x2F;view_transformer_bevdet_bevdepth.py</td>
<td>Lift, Splat, Shoot: Encoding Images From Arbitrary Camera Rigs by Implicitly Unprojecting to 3D</td>
<td></td>
<td></td>
</tr>
<tr>
<td>BEVEncoder</td>
<td>img_bev_encoder_backbone</td>
<td>[B, 64, 128, 128]</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>$\downarrow$</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>[[B, 128, 64, 64],</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>[B, 256, 32, 32],</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>[B, 512, 16, 16]]</td>
<td>ResNetForBevDet</td>
<td>mmdet3d&#x2F;models&#x2F;backbones&#x2F;resnet.py</td>
<td>Deep Residual Learning for Image Recognition</td>
<td></td>
<td></td>
</tr>
<tr>
<td></td>
<td>img_bev_encoder_neck</td>
<td>[[B, 128, 64, 64],</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>[B, 256, 32, 32],</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>[B, 512, 16, 16]]</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>$\downarrow$</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>[B, 256, 128, 128]</td>
<td>FPN_LSS</td>
<td>mmdet3d&#x2F;models&#x2F;necks&#x2F;lss_fpn.py</td>
<td>Feature Pyramid Networks for Object Detection</td>
<td></td>
<td></td>
</tr>
<tr>
<td>Head</td>
<td>pts_bbox_head</td>
<td>[B, 256, 128, 128]</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>$\downarrow$</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>[B, …, 128, 128]</td>
<td>CenterHeadBEVDet</td>
<td>mmdet3d&#x2F;models&#x2F;dense_heads&#x2F;centerpoint_head_bevdet.py</td>
<td>Center-based 3D Object Detection and Tracking</td>
<td></td>
<td></td>
</tr>
</tbody></table>
<h3 id="2-2-2-模型的各个组件"><a href="#2-2-2-模型的各个组件" class="headerlink" title="2.2.2 模型的各个组件"></a>2.2.2 模型的各个组件</h3><p>MMDet3D通常把模型的各个组成成分分成6种类型：</p>
<ul>
<li>骨干网络（backbone）：通常采用 FCN 网络来提取特征图，如 **_ResNet _**和 **<em>SECOND</em>**。</li>
<li>颈部网络（neck）：位于 backbones 和 heads 之间的组成模块，如**_ FPN_** 和 **<em>SECONDFPN</em>**。</li>
<li>RoI 提取器（RoI extractor）：用于从特征图中提取 RoI 特征的组成模块，如**_ H3DRoIHead_** 和 **<em>PartAggregationROIHead</em>**。</li>
<li>编码器（encoder）：包括 voxel layer、voxel encoder 和 middle encoder 等进入 backbone 前所使用的基于 voxel 的方法，如 <strong><em>HardVFE</em></strong> 和**_ PointPillarsScatter_**。</li>
<li>检测头（head）：用于特定任务的组成模块，如检测框的预测和掩码的预测。</li>
<li>损失函数（loss）：heads 中用于计算损失函数的组成模块，如**_ FocalLoss_<strong>、</strong><em>L1Loss</em>** 和**_ GHMLoss_**。</li>
</ul>
<h4 id="Detector"><a href="#Detector" class="headerlink" title="Detector"></a>Detector</h4><p>对于3D检测模型，模型的总体框架由Dectectors定义，也即BEVDET-sttiny的配置文件中，model的type。在Detector中定义从输入的六张图像到模型输出结果的模型训练、测试的整体流程，包括对模型各子组件的调用。对于BEVDET-sttiny，其model的type为“BEVDet”，具体定义如下</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> torch</span><br><span class="line"><span class="keyword">from</span> mmcv.runner <span class="keyword">import</span> force_fp32</span><br><span class="line"><span class="keyword">import</span> torch.nn.functional <span class="keyword">as</span> F</span><br><span class="line"><span class="keyword">from</span> mmdet.models <span class="keyword">import</span> DETECTORS</span><br><span class="line"><span class="keyword">from</span> .centerpoint <span class="keyword">import</span> CenterPoint</span><br><span class="line"><span class="keyword">from</span> .. <span class="keyword">import</span> builder</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@DETECTORS.register_module()</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">BEVDet</span>(<span class="title class_ inherited__">CenterPoint</span>):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, img_view_transformer, img_bev_encoder_backbone, img_bev_encoder_neck, **kwargs</span>):</span><br><span class="line">        <span class="built_in">super</span>(BEVDet, self).__init__(**kwargs)</span><br><span class="line">        self.img_view_transformer = builder.build_neck(img_view_transformer)</span><br><span class="line">        self.img_bev_encoder_backbone = builder.build_backbone(img_bev_encoder_backbone)</span><br><span class="line">        self.img_bev_encoder_neck = builder.build_neck(img_bev_encoder_neck)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">image_encoder</span>(<span class="params">self, img</span>):</span><br><span class="line">        imgs = img</span><br><span class="line">        B, N, C, imH, imW = imgs.shape</span><br><span class="line">        imgs = imgs.view(B * N, C, imH, imW)</span><br><span class="line">        x = self.img_backbone(imgs)</span><br><span class="line">        <span class="keyword">if</span> self.with_img_neck:</span><br><span class="line">            x = self.img_neck(x)</span><br><span class="line">        _, output_dim, ouput_H, output_W = x.shape</span><br><span class="line">        x = x.view(B, N, output_dim, ouput_H, output_W)</span><br><span class="line">        <span class="keyword">return</span> x</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">bev_encoder</span>(<span class="params">self, x</span>):</span><br><span class="line">        x = self.img_bev_encoder_backbone(x)</span><br><span class="line">        x = self.img_bev_encoder_neck(x)</span><br><span class="line">        <span class="keyword">return</span> x</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">extract_img_feat</span>(<span class="params">self, img, img_metas</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;Extract features of images.&quot;&quot;&quot;</span></span><br><span class="line">        x = self.image_encoder(img[<span class="number">0</span>])</span><br><span class="line">        x = self.img_view_transformer([x] + img[<span class="number">1</span>:])</span><br><span class="line">        x = self.bev_encoder(x)</span><br><span class="line">        <span class="keyword">return</span> [x]</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">extract_feat</span>(<span class="params">self, points, img, img_metas</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;Extract features from images and points.&quot;&quot;&quot;</span></span><br><span class="line">        img_feats = self.extract_img_feat(img, img_metas)</span><br><span class="line">        pts_feats = <span class="literal">None</span></span><br><span class="line">        <span class="keyword">return</span> (img_feats, pts_feats)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">forward_train</span>(<span class="params">self,</span></span><br><span class="line"><span class="params">                      points=<span class="literal">None</span>,</span></span><br><span class="line"><span class="params">                      img_metas=<span class="literal">None</span>,</span></span><br><span class="line"><span class="params">                      gt_bboxes_3d=<span class="literal">None</span>,</span></span><br><span class="line"><span class="params">                      gt_labels_3d=<span class="literal">None</span>,</span></span><br><span class="line"><span class="params">                      gt_labels=<span class="literal">None</span>,</span></span><br><span class="line"><span class="params">                      gt_bboxes=<span class="literal">None</span>,</span></span><br><span class="line"><span class="params">                      img_inputs=<span class="literal">None</span>,</span></span><br><span class="line"><span class="params">                      proposals=<span class="literal">None</span>,</span></span><br><span class="line"><span class="params">                      gt_bboxes_ignore=<span class="literal">None</span></span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;Forward training function.&quot;&quot;&quot;</span></span><br><span class="line">        img_feats, pts_feats = self.extract_feat(</span><br><span class="line">            points, img=img_inputs, img_metas=img_metas)</span><br><span class="line">        <span class="keyword">assert</span> self.with_pts_bbox</span><br><span class="line">        losses = <span class="built_in">dict</span>()</span><br><span class="line">        losses_pts = self.forward_pts_train(img_feats, gt_bboxes_3d,</span><br><span class="line">                                            gt_labels_3d, img_metas,</span><br><span class="line">                                            gt_bboxes_ignore)</span><br><span class="line">        losses.update(losses_pts)</span><br><span class="line">        <span class="keyword">return</span> losses</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">forward_test</span>(<span class="params">self, points=<span class="literal">None</span>, img_metas=<span class="literal">None</span>, img_inputs=<span class="literal">None</span>, **kwargs</span>):</span><br><span class="line">        <span class="keyword">for</span> var, name <span class="keyword">in</span> [(img_inputs, <span class="string">&#x27;img_inputs&#x27;</span>), (img_metas, <span class="string">&#x27;img_metas&#x27;</span>)]:</span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> <span class="built_in">isinstance</span>(var, <span class="built_in">list</span>):</span><br><span class="line">                <span class="keyword">raise</span> TypeError(<span class="string">&#x27;&#123;&#125; must be a list, but got &#123;&#125;&#x27;</span>.<span class="built_in">format</span>(</span><br><span class="line">                    name, <span class="built_in">type</span>(var)))</span><br><span class="line"></span><br><span class="line">        num_augs = <span class="built_in">len</span>(img_inputs)</span><br><span class="line">        <span class="keyword">if</span> num_augs != <span class="built_in">len</span>(img_metas):</span><br><span class="line">            <span class="keyword">raise</span> ValueError(</span><br><span class="line">                <span class="string">&#x27;num of augmentations (&#123;&#125;) != num of image meta (&#123;&#125;)&#x27;</span>.<span class="built_in">format</span>(</span><br><span class="line">                    <span class="built_in">len</span>(img_inputs), <span class="built_in">len</span>(img_metas)))</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> <span class="built_in">isinstance</span>(img_inputs[<span class="number">0</span>][<span class="number">0</span>], <span class="built_in">list</span>):</span><br><span class="line">            img_inputs = [img_inputs] <span class="keyword">if</span> img_inputs <span class="keyword">is</span> <span class="literal">None</span> <span class="keyword">else</span> img_inputs</span><br><span class="line">            points = [points] <span class="keyword">if</span> points <span class="keyword">is</span> <span class="literal">None</span> <span class="keyword">else</span> points</span><br><span class="line">            <span class="keyword">return</span> self.simple_test(points[<span class="number">0</span>], img_metas[<span class="number">0</span>], img_inputs[<span class="number">0</span>], **kwargs)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">return</span> self.aug_test(<span class="literal">None</span>, img_metas[<span class="number">0</span>], img_inputs[<span class="number">0</span>], **kwargs)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">simple_test</span>(<span class="params">self, points, img_metas, img=<span class="literal">None</span>, rescale=<span class="literal">False</span></span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;Test function without augmentaiton.&quot;&quot;&quot;</span></span><br><span class="line">        img_feats, _ = self.extract_feat(points, img=img, img_metas=img_metas)</span><br><span class="line">        bbox_list = [<span class="built_in">dict</span>() <span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(img_metas))]</span><br><span class="line">        bbox_pts = self.simple_test_pts(img_feats, img_metas, rescale=rescale)</span><br><span class="line">        <span class="keyword">for</span> result_dict, pts_bbox <span class="keyword">in</span> <span class="built_in">zip</span>(bbox_list, bbox_pts):</span><br><span class="line">            result_dict[<span class="string">&#x27;pts_bbox&#x27;</span>] = pts_bbox</span><br><span class="line">        <span class="keyword">return</span> bbox_list</span><br></pre></td></tr></table></figure>

<h4 id="BackBone"><a href="#BackBone" class="headerlink" title="BackBone"></a>BackBone</h4><p>BackBone通常是用于提取图像特征的骨干网络，一般是指定已内置的网络直接调用，包括_<strong>ResNET</strong>_、**<em>SECOND</em><strong>、</strong><em>DLANet</em>**等。对于BEVDET-sttiny，其img_backbone的type为“SwinTransformer”、img_bev_encoder_backbone的type为“ResNetForBEVDet”，后者的具体定义如下</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> torch <span class="keyword">import</span> nn</span><br><span class="line"><span class="keyword">from</span> mmdet.models.backbones.resnet <span class="keyword">import</span> Bottleneck, BasicBlock</span><br><span class="line"><span class="keyword">import</span> torch.utils.checkpoint <span class="keyword">as</span> checkpoint</span><br><span class="line"><span class="keyword">from</span> mmdet.models <span class="keyword">import</span> BACKBONES</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@BACKBONES.register_module()</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ResNetForBEVDet</span>(nn.Module):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, numC_input, num_layer=[<span class="number">2</span>,<span class="number">2</span>,<span class="number">2</span>], num_channels=<span class="literal">None</span>, stride=[<span class="number">2</span>,<span class="number">2</span>,<span class="number">2</span>],</span></span><br><span class="line"><span class="params">                 backbone_output_ids=<span class="literal">None</span>, norm_cfg=<span class="built_in">dict</span>(<span class="params"><span class="built_in">type</span>=<span class="string">&#x27;BN&#x27;</span></span>),</span></span><br><span class="line"><span class="params">                 with_cp=<span class="literal">False</span>, block_type=<span class="string">&#x27;Basic&#x27;</span>,</span>):</span><br><span class="line">        <span class="built_in">super</span>(ResNetForBEVDet, self).__init__()</span><br><span class="line">        <span class="keyword">assert</span> <span class="built_in">len</span>(num_layer)==<span class="built_in">len</span>(stride)</span><br><span class="line">        num_channels = [numC_input*<span class="number">2</span>**(i+<span class="number">1</span>) <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(num_layer))] \</span><br><span class="line">            <span class="keyword">if</span> num_channels <span class="keyword">is</span> <span class="literal">None</span> <span class="keyword">else</span> num_channels</span><br><span class="line">        self.backbone_output_ids = <span class="built_in">range</span>(<span class="built_in">len</span>(num_layer)) \</span><br><span class="line">            <span class="keyword">if</span> backbone_output_ids <span class="keyword">is</span> <span class="literal">None</span> <span class="keyword">else</span> backbone_output_ids</span><br><span class="line">        layers = []</span><br><span class="line">        <span class="keyword">if</span> block_type == <span class="string">&#x27;BottleNeck&#x27;</span>:</span><br><span class="line">            curr_numC = numC_input</span><br><span class="line">            <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(num_layer)):</span><br><span class="line">                layer=[Bottleneck(curr_numC, num_channels[i]//<span class="number">4</span>, stride=stride[i],</span><br><span class="line">                                  downsample=nn.Conv2d(curr_numC,num_channels[i],<span class="number">3</span>,stride[i],<span class="number">1</span>),</span><br><span class="line">                                  norm_cfg=norm_cfg)]</span><br><span class="line">                curr_numC= num_channels[i]</span><br><span class="line">                layer.extend([Bottleneck(curr_numC, curr_numC//<span class="number">4</span>,</span><br><span class="line">                                         norm_cfg=norm_cfg) <span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(num_layer[i]-<span class="number">1</span>)])</span><br><span class="line">                layers.append(nn.Sequential(*layer))</span><br><span class="line">        <span class="keyword">elif</span> block_type == <span class="string">&#x27;Basic&#x27;</span>:</span><br><span class="line">            curr_numC = numC_input</span><br><span class="line">            <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(num_layer)):</span><br><span class="line">                layer=[BasicBlock(curr_numC, num_channels[i], stride=stride[i],</span><br><span class="line">                                  downsample=nn.Conv2d(curr_numC,num_channels[i],<span class="number">3</span>,stride[i],<span class="number">1</span>),</span><br><span class="line">                                  norm_cfg=norm_cfg)]</span><br><span class="line">                curr_numC= num_channels[i]</span><br><span class="line">                layer.extend([BasicBlock(curr_numC, curr_numC, norm_cfg=norm_cfg) <span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(num_layer[i]-<span class="number">1</span>)])</span><br><span class="line">                layers.append(nn.Sequential(*layer))</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">assert</span> <span class="literal">False</span></span><br><span class="line">        self.layers = nn.Sequential(*layers)</span><br><span class="line">        self.with_cp = with_cp</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">forward</span>(<span class="params">self, x</span>):</span><br><span class="line">        feats = []</span><br><span class="line">        x_tmp = x</span><br><span class="line">        <span class="keyword">for</span> lid, layer <span class="keyword">in</span> <span class="built_in">enumerate</span>(self.layers):</span><br><span class="line">            <span class="keyword">if</span> self.with_cp:</span><br><span class="line">                x_tmp = checkpoint.checkpoint(layer, x_tmp)</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                x_tmp = layer(x_tmp)</span><br><span class="line">            <span class="keyword">if</span> lid <span class="keyword">in</span> self.backbone_output_ids:</span><br><span class="line">                feats.append(x_tmp)</span><br><span class="line">        <span class="keyword">return</span> feats</span><br></pre></td></tr></table></figure>

<h4 id="Neck"><a href="#Neck" class="headerlink" title="Neck"></a>Neck</h4><p>Neck一般是FPN，用于增强模型对不同scale的目标的处理能力，一般是指定已内置的网络直接调用，包括**_ FPN_** 、**<em>SECONDFPN</em>**等。对于BEVDET-sttiny，其img_neck和img_bev_encoder_neck的type均为“FPN_LSS”，具体定义如下</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> torch</span><br><span class="line"><span class="keyword">import</span> torch.nn <span class="keyword">as</span> nn</span><br><span class="line"><span class="keyword">from</span> mmcv.cnn <span class="keyword">import</span> build_norm_layer</span><br><span class="line"><span class="keyword">from</span> mmdet.models <span class="keyword">import</span> NECKS</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@NECKS.register_module()</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">FPN_LSS</span>(nn.Module):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, in_channels, out_channels, scale_factor=<span class="number">4</span>,</span></span><br><span class="line"><span class="params">                 input_feature_index=(<span class="params"><span class="number">0</span>, <span class="number">2</span></span>),</span></span><br><span class="line"><span class="params">                 norm_cfg=<span class="built_in">dict</span>(<span class="params"><span class="built_in">type</span>=<span class="string">&#x27;BN&#x27;</span></span>),</span></span><br><span class="line"><span class="params">                 extra_upsample=<span class="number">2</span>,</span></span><br><span class="line"><span class="params">                 lateral=<span class="literal">None</span></span>):</span><br><span class="line">        <span class="built_in">super</span>().__init__()</span><br><span class="line">        self.input_feature_index = input_feature_index</span><br><span class="line">        self.extra_upsample = extra_upsample <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span></span><br><span class="line">        self.up = nn.Upsample(scale_factor=scale_factor, mode=<span class="string">&#x27;bilinear&#x27;</span>, align_corners=<span class="literal">True</span>)</span><br><span class="line">        channels_factor = <span class="number">2</span> <span class="keyword">if</span> self.extra_upsample <span class="keyword">else</span> <span class="number">1</span></span><br><span class="line">        self.conv = nn.Sequential(</span><br><span class="line">            nn.Conv2d(in_channels, out_channels * channels_factor, kernel_size=<span class="number">3</span>, padding=<span class="number">1</span>, bias=<span class="literal">False</span>),</span><br><span class="line">            build_norm_layer(norm_cfg, out_channels * channels_factor, postfix=<span class="number">0</span>)[<span class="number">1</span>],</span><br><span class="line">            nn.ReLU(inplace=<span class="literal">True</span>),</span><br><span class="line">            nn.Conv2d(out_channels * channels_factor, out_channels * channels_factor,</span><br><span class="line">                      kernel_size=<span class="number">3</span>, padding=<span class="number">1</span>, bias=<span class="literal">False</span>),</span><br><span class="line">            build_norm_layer(norm_cfg, out_channels * channels_factor, postfix=<span class="number">0</span>)[<span class="number">1</span>],</span><br><span class="line">            nn.ReLU(inplace=<span class="literal">True</span>),</span><br><span class="line">        )</span><br><span class="line">        <span class="keyword">if</span> self.extra_upsample:</span><br><span class="line">            self.up2 = nn.Sequential(</span><br><span class="line">                nn.Upsample(scale_factor=extra_upsample , mode=<span class="string">&#x27;bilinear&#x27;</span>, align_corners=<span class="literal">True</span>),</span><br><span class="line">                nn.Conv2d(out_channels * channels_factor, out_channels, kernel_size=<span class="number">3</span>, padding=<span class="number">1</span>, bias=<span class="literal">False</span>),</span><br><span class="line">                build_norm_layer(norm_cfg, out_channels, postfix=<span class="number">0</span>)[<span class="number">1</span>],</span><br><span class="line">                nn.ReLU(inplace=<span class="literal">True</span>),</span><br><span class="line">                nn.Conv2d(out_channels, out_channels, kernel_size=<span class="number">1</span>, padding=<span class="number">0</span>),</span><br><span class="line">            )</span><br><span class="line">        self.lateral=  lateral <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span></span><br><span class="line">        <span class="keyword">if</span> self.lateral:</span><br><span class="line">            self.lateral_conv = nn.Sequential(</span><br><span class="line">                nn.Conv2d(lateral, lateral,</span><br><span class="line">                          kernel_size=<span class="number">1</span>, padding=<span class="number">0</span>, bias=<span class="literal">False</span>),</span><br><span class="line">                build_norm_layer(norm_cfg, lateral, postfix=<span class="number">0</span>)[<span class="number">1</span>],</span><br><span class="line">                nn.ReLU(inplace=<span class="literal">True</span>),</span><br><span class="line">        )</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">forward</span>(<span class="params">self, feats</span>):</span><br><span class="line">        x2, x1 = feats[self.input_feature_index[<span class="number">0</span>]], feats[self.input_feature_index[<span class="number">1</span>]]</span><br><span class="line">        <span class="keyword">if</span> self.lateral:</span><br><span class="line">            x2 = self.lateral_conv(x2)</span><br><span class="line">        x1 = self.up(x1)</span><br><span class="line">        x1 = torch.cat([x2, x1], dim=<span class="number">1</span>)</span><br><span class="line">        x = self.conv(x1)</span><br><span class="line">        <span class="keyword">if</span> self.extra_upsample:</span><br><span class="line">            x = self.up2(x)</span><br><span class="line">        <span class="keyword">return</span> x</span><br></pre></td></tr></table></figure>

<h4 id="Head"><a href="#Head" class="headerlink" title="Head"></a>Head</h4><p>Head通常用于完成特定任务，loss函数和真值数据的处理也通常在这里完成，是稍微复杂一些的模块。MMDet3D已经提供的模块包括**<em>FCOSMono3DHead</em>** 、**<em>CenterHead</em>**等，对于任务相近的模型，可以选择直接继承这些任务增加一些自定义的函数，也可以直接继承Head的基类实现。对于BEVDET-sttiny，其pts_bbox_head的type为“CenterHeadBEVDet”，具体定义如下</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> copy</span><br><span class="line"><span class="keyword">import</span> torch</span><br><span class="line"><span class="keyword">from</span> mmcv.cnn <span class="keyword">import</span> ConvModule, build_conv_layer</span><br><span class="line"><span class="keyword">from</span> mmcv.runner <span class="keyword">import</span> BaseModule, force_fp32</span><br><span class="line"><span class="keyword">from</span> torch <span class="keyword">import</span> nn</span><br><span class="line"><span class="keyword">from</span> mmdet3d.core <span class="keyword">import</span> (circle_nms, draw_heatmap_gaussian, gaussian_radius, xywhr2xyxyr)</span><br><span class="line"><span class="keyword">from</span> mmdet3d.core.post_processing <span class="keyword">import</span> nms_bev</span><br><span class="line"><span class="keyword">from</span> mmdet3d.models <span class="keyword">import</span> builder</span><br><span class="line"><span class="keyword">from</span> mmdet3d.models.utils <span class="keyword">import</span> clip_sigmoid</span><br><span class="line"><span class="keyword">from</span> mmdet.core <span class="keyword">import</span> build_bbox_coder, multi_apply</span><br><span class="line"><span class="keyword">from</span> ..builder <span class="keyword">import</span> HEADS, build_loss</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@HEADS.register_module()</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">CenterHeadBEVDet</span>(<span class="title class_ inherited__">BaseModule</span>):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self,</span></span><br><span class="line"><span class="params">                 in_channels=[<span class="number">128</span>],</span></span><br><span class="line"><span class="params">                 tasks=<span class="literal">None</span>,</span></span><br><span class="line"><span class="params">                 train_cfg=<span class="literal">None</span>,</span></span><br><span class="line"><span class="params">                 test_cfg=<span class="literal">None</span>,</span></span><br><span class="line"><span class="params">                 bbox_coder=<span class="literal">None</span>,</span></span><br><span class="line"><span class="params">                 loss_cls=<span class="built_in">dict</span>(<span class="params"><span class="built_in">type</span>=<span class="string">&#x27;GaussianFocalLoss&#x27;</span>, reduction=<span class="string">&#x27;mean&#x27;</span></span>),</span></span><br><span class="line"><span class="params">                 loss_bbox=<span class="built_in">dict</span>(<span class="params"></span></span></span><br><span class="line"><span class="params"><span class="params">                     <span class="built_in">type</span>=<span class="string">&#x27;L1Loss&#x27;</span>, reduction=<span class="string">&#x27;none&#x27;</span>, loss_weight=<span class="number">0.25</span></span>),</span></span><br><span class="line"><span class="params">                 separate_head=<span class="built_in">dict</span>(<span class="params"></span></span></span><br><span class="line"><span class="params"><span class="params">                     <span class="built_in">type</span>=<span class="string">&#x27;SeparateHead&#x27;</span>, init_bias=-<span class="number">2.19</span>, final_kernel=<span class="number">3</span></span>),</span></span><br><span class="line"><span class="params">                 </span>):</span><br><span class="line">        <span class="keyword">assert</span> init_cfg <span class="keyword">is</span> <span class="literal">None</span>, <span class="string">&#x27;To prevent abnormal initialization &#x27;</span> \</span><br><span class="line">            <span class="string">&#x27;behavior, init_cfg is not allowed to be set&#x27;</span></span><br><span class="line">        <span class="built_in">super</span>(CenterHeadBEVDet, self).__init__(init_cfg=init_cfg)</span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">forward_single</span>(<span class="params">self, x</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;Forward function for CenterPoint.&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">forward</span>(<span class="params">self, feats</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;Forward pass.&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">return</span> multi_apply(self.forward_single, feats)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_gather_feat</span>(<span class="params">self, feat, ind, mask=<span class="literal">None</span></span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;Gather feature map&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">get_targets</span>(<span class="params">self, gt_bboxes_3d, gt_labels_3d</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;Generate targets&quot;&quot;&quot;</span></span><br><span class="line">        heatmaps, anno_boxes, inds, masks = multi_apply(</span><br><span class="line">            self.get_targets_single, gt_bboxes_3d, gt_labels_3d)</span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">get_targets_single</span>(<span class="params">self, gt_bboxes_3d, gt_labels_3d</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;Generate training targets for a single sample&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"><span class="meta">    @force_fp32(<span class="params">apply_to=(<span class="params"><span class="string">&#x27;preds_dicts&#x27;</span></span>)</span>)</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">loss</span>(<span class="params">self, gt_bboxes_3d, gt_labels_3d, preds_dicts, **kwargs</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;Loss function for CenterHead&quot;&quot;&quot;</span></span><br><span class="line">        heatmaps, anno_boxes, inds, masks = self.get_targets(</span><br><span class="line">            gt_bboxes_3d, gt_labels_3d)</span><br><span class="line">        loss_dict = <span class="built_in">dict</span>()</span><br><span class="line">        <span class="keyword">for</span> task_id, preds_dict <span class="keyword">in</span> <span class="built_in">enumerate</span>(preds_dicts):</span><br><span class="line">            <span class="comment"># heatmap focal loss</span></span><br><span class="line">            preds_dict[<span class="number">0</span>][<span class="string">&#x27;heatmap&#x27;</span>] = clip_sigmoid(preds_dict[<span class="number">0</span>][<span class="string">&#x27;heatmap&#x27;</span>])</span><br><span class="line">            num_pos = heatmaps[task_id].eq(<span class="number">1</span>).<span class="built_in">float</span>().<span class="built_in">sum</span>().item()</span><br><span class="line">            loss_heatmap = self.loss_cls(</span><br><span class="line">                preds_dict[<span class="number">0</span>][<span class="string">&#x27;heatmap&#x27;</span>],</span><br><span class="line">                heatmaps[task_id],</span><br><span class="line">                avg_factor=<span class="built_in">max</span>(num_pos, <span class="number">1</span>))</span><br><span class="line">            target_box = anno_boxes[task_id]</span><br><span class="line">            preds_dict[<span class="number">0</span>][<span class="string">&#x27;anno_box&#x27;</span>] = torch.cat(</span><br><span class="line">                (preds_dict[<span class="number">0</span>][<span class="string">&#x27;reg&#x27;</span>], preds_dict[<span class="number">0</span>][<span class="string">&#x27;height&#x27;</span>],</span><br><span class="line">                 preds_dict[<span class="number">0</span>][<span class="string">&#x27;dim&#x27;</span>], preds_dict[<span class="number">0</span>][<span class="string">&#x27;rot&#x27;</span>],</span><br><span class="line">                 preds_dict[<span class="number">0</span>][<span class="string">&#x27;vel&#x27;</span>]),</span><br><span class="line">                dim=<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">            ind = inds[task_id]</span><br><span class="line">            num = masks[task_id].<span class="built_in">float</span>().<span class="built_in">sum</span>()</span><br><span class="line">            pred = preds_dict[<span class="number">0</span>][<span class="string">&#x27;anno_box&#x27;</span>].permute(<span class="number">0</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">1</span>).contiguous()</span><br><span class="line">            pred = pred.view(pred.size(<span class="number">0</span>), -<span class="number">1</span>, pred.size(<span class="number">3</span>))</span><br><span class="line">            pred = self._gather_feat(pred, ind)</span><br><span class="line">            mask = masks[task_id].unsqueeze(<span class="number">2</span>).expand_as(target_box).<span class="built_in">float</span>()</span><br><span class="line">            isnotnan = (~torch.isnan(target_box)).<span class="built_in">float</span>()</span><br><span class="line">            mask *= isnotnan</span><br><span class="line"></span><br><span class="line">            code_weights = self.train_cfg.get(<span class="string">&#x27;code_weights&#x27;</span>, <span class="literal">None</span>)</span><br><span class="line">            bbox_weights = mask * mask.new_tensor(code_weights)</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> self.task_specific:</span><br><span class="line">                name_list = [<span class="string">&#x27;xy&#x27;</span>, <span class="string">&#x27;z&#x27;</span>, <span class="string">&#x27;whl&#x27;</span>, <span class="string">&#x27;yaw&#x27;</span>, <span class="string">&#x27;vel&#x27;</span>]</span><br><span class="line">                clip_index = [<span class="number">0</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">6</span>, <span class="number">8</span>, <span class="number">10</span>]</span><br><span class="line">                <span class="keyword">for</span> reg_task_id <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(name_list)):</span><br><span class="line">                    pred_tmp = pred[..., clip_index[reg_task_id]:clip_index[reg_task_id + <span class="number">1</span>]]</span><br><span class="line">                    target_box_tmp = target_box[..., clip_index[reg_task_id]:clip_index[reg_task_id + <span class="number">1</span>]]</span><br><span class="line">                    bbox_weights_tmp = bbox_weights[..., clip_index[reg_task_id]:clip_index[reg_task_id + <span class="number">1</span>]]</span><br><span class="line">                    loss_bbox_tmp = self.loss_bbox(</span><br><span class="line">                        pred_tmp, target_box_tmp, bbox_weights_tmp, avg_factor=(num + <span class="number">1e-4</span>))</span><br><span class="line">                    loss_dict[<span class="string">f&#x27;%stask<span class="subst">&#123;task_id&#125;</span>.loss_%s&#x27;</span> % (self.loss_prefix, name_list[reg_task_id])] = loss_bbox_tmp</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                loss_bbox = self.loss_bbox(</span><br><span class="line">                    pred, target_box, bbox_weights, avg_factor=(num + <span class="number">1e-4</span>))</span><br><span class="line">                loss_dict[<span class="string">f&#x27;task<span class="subst">&#123;task_id&#125;</span>.loss_bbox&#x27;</span>] = loss_bbox</span><br><span class="line"></span><br><span class="line">            loss_dict[<span class="string">f&#x27;%stask<span class="subst">&#123;task_id&#125;</span>.loss_heatmap&#x27;</span> % (self.loss_prefix)] = loss_heatmap</span><br><span class="line">        <span class="keyword">return</span> loss_dict</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">get_bboxes</span>(<span class="params">self, preds_dicts, img_metas, img=<span class="literal">None</span>, rescale=<span class="literal">False</span></span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;Generate bboxes from bbox head predictions&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">get_task_detections</span>(<span class="params">self, num_class_with_bg, batch_cls_preds,</span></span><br><span class="line"><span class="params">                            batch_reg_preds, batch_cls_labels, img_metas, task_id</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;Rotate nms for each task&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="新增自定义模型组件"><a href="#新增自定义模型组件" class="headerlink" title="新增自定义模型组件"></a>新增自定义模型组件</h4><p>此处以新增BackBone为例介绍如何新增自定义模型组件，其他组件的方法类似。<br>创建一个新文件mmdet3d&#x2F;models&#x2F;backbones&#x2F;second.py</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> torch.nn <span class="keyword">as</span> nn</span><br><span class="line"><span class="keyword">from</span> ..builder <span class="keyword">import</span> BACKBONES</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@BACKBONES.register_module()</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">SECOND</span>(<span class="title class_ inherited__">BaseModule</span>):</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, arg1, arg2</span>):</span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">forward</span>(<span class="params">self, x</span>):  <span class="comment"># should return a tuple</span></span><br><span class="line">        <span class="keyword">pass</span></span><br></pre></td></tr></table></figure>

<p>在&#x2F;mmdet3d&#x2F;models&#x2F;backbones&#x2F;<strong>init</strong>.py中导入该新增模块</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> .second <span class="keyword">import</span> SECOND</span><br></pre></td></tr></table></figure>

<p>在配置文件中使用新增的BackBone</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">model = <span class="built_in">dict</span>(</span><br><span class="line">    ...</span><br><span class="line">    backbone=<span class="built_in">dict</span>(</span><br><span class="line">        <span class="built_in">type</span>=<span class="string">&#x27;SECOND&#x27;</span>,</span><br><span class="line">        arg1=xxx,</span><br><span class="line">        arg2=xxx),</span><br><span class="line">    ...</span><br></pre></td></tr></table></figure>

                
            </div>
            <hr/>

            

    <div class="reprint" id="reprint-statement">
        
            <div class="reprint__author">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-user">
                        Author:
                    </i>
                </span>
                <span class="reprint-info">
                    <a href="/about" rel="external nofollow noreferrer">Jingyi Yu</a>
                </span>
            </div>
            <div class="reprint__type">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-link">
                        Link:
                    </i>
                </span>
                <span class="reprint-info">
                    <a href="http://yoursite.com/2022/10/20/Code-%E5%9F%BA%E4%BA%8EBEVDET%E5%89%96%E6%9E%90MMDet3D%E6%9E%B6%E6%9E%84/">http://yoursite.com/2022/10/20/Code-%E5%9F%BA%E4%BA%8EBEVDET%E5%89%96%E6%9E%90MMDet3D%E6%9E%B6%E6%9E%84/</a>
                </span>
            </div>
            <div class="reprint__notice">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-copyright">
                        Reprint policy:
                    </i>
                </span>
                <span class="reprint-info">
                    All articles in this blog are used except for special statements
                    <a href="https://creativecommons.org/licenses/by/4.0/deed.zh" rel="external nofollow noreferrer" target="_blank">CC BY 4.0</a>
                    reprint policy. If reproduced, please indicate source
                    <a href="/about" target="_blank">Jingyi Yu</a>
                    !
                </span>
            </div>
        
    </div>

    <script async defer>
      document.addEventListener("copy", function (e) {
        let toastHTML = '<span>Copied successfully, please follow the reprint policy of this article</span><button class="btn-flat toast-action" onclick="navToReprintStatement()" style="font-size: smaller">more</a>';
        M.toast({html: toastHTML})
      });

      function navToReprintStatement() {
        $("html, body").animate({scrollTop: $("#reprint-statement").offset().top - 80}, 800);
      }
    </script>



            <div class="tag_share" style="display: block;">
                <div class="post-meta__tag-list" style="display: inline-block;">
                    
                        <div class="article-tag">
                            
                                <a href="/tags/Multi-view-3D/">
                                    <span class="chip bg-color">Multi-view 3D</span>
                                </a>
                            
                        </div>
                    
                </div>
                <div class="post_share" style="zoom: 80%; width: fit-content; display: inline-block; float: right; margin: -0.15rem 0;">
                    <link rel="stylesheet" type="text/css" href="/libs/share/css/share.min.css">
<div id="article-share">

    
    <div class="social-share" data-sites="twitter,facebook,google,qq,qzone,wechat,weibo,douban,linkedin" data-wechat-qrcode-helper="<p>微信扫一扫即可分享！</p>"></div>
    <script src="/libs/share/js/social-share.min.js"></script>
    

    

</div>

                </div>
            </div>
            
                <div id="reward">
    <a href="#rewardModal" class="reward-link modal-trigger btn-floating btn-medium waves-effect waves-light red">赏</a>

    <!-- Modal Structure -->
    <div id="rewardModal" class="modal">
        <div class="modal-content">
            <a class="close modal-close"><i class="fas fa-times"></i></a>
            <h4 class="reward-title">你的赏识是我前进的动力</h4>
            <div class="reward-content">
                <div class="reward-tabs">
                    <ul class="tabs row">
                        <li class="tab col s6 alipay-tab waves-effect waves-light"><a href="#alipay">支付宝</a></li>
                        <li class="tab col s6 wechat-tab waves-effect waves-light"><a href="#wechat">微 信</a></li>
                    </ul>
                    <div id="alipay">
                        <img src="/medias/reward/alipay.jpg" class="reward-img" alt="支付宝打赏二维码">
                    </div>
                    <div id="wechat">
                        <img src="/medias/reward/wechat.png" class="reward-img" alt="微信打赏二维码">
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    $(function () {
        $('.tabs').tabs();
    });
</script>

            
        </div>
    </div>

    

    

    

    

    

    

    

    

    

<article id="prenext-posts" class="prev-next articles">
    <div class="row article-row">
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge left-badge text-color">
                <i class="fas fa-chevron-left"></i>&nbsp;Previous</div>
            <div class="card">
                <a href="/2022/10/25/Paper-PGD-Probabilistic%20and%20Geometric%20Depth_%20Detecting%20Objects%20in%20Perspective/">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/5.jpg" class="responsive-img" alt="PGD-Probabilistic and Geometric Depth_ Detecting Objects in Perspective">
                        
                        <span class="card-title">PGD-Probabilistic and Geometric Depth_ Detecting Objects in Perspective</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            本文整理了Probabilistic and Geometric Depth_ Detecting Objects in Perspective论文主要内容
                        
                    </div>
                    <div class="publish-info">
                        <span class="publish-date">
                            <i class="far fa-clock fa-fw icon-date"></i>2022-10-25
                        </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/Paper/" class="post-category">
                                    Paper
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/Multi-view-3D/">
                        <span class="chip bg-color">Multi-view 3D</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge right-badge text-color">
                Next&nbsp;<i class="fas fa-chevron-right"></i>
            </div>
            <div class="card">
                <a href="/2022/09/26/Paper-BEV%E6%A8%A1%E5%9E%8B%E6%B7%B1%E5%BA%A6%E4%BC%B0%E8%AE%A1%E6%A8%A1%E5%9D%97Overview/">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/14.jpg" class="responsive-img" alt="BEV模型深度估计模块Overview">
                        
                        <span class="card-title">BEV模型深度估计模块Overview</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            本文对BEV模型深度估计模块进行了梳理。
                        
                    </div>
                    <div class="publish-info">
                            <span class="publish-date">
                                <i class="far fa-clock fa-fw icon-date"></i>2022-09-26
                            </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/Paper/" class="post-category">
                                    Paper
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/Multi-view-3D/">
                        <span class="chip bg-color">Multi-view 3D</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
    </div>
</article>

</div>



<!-- 代码块功能依赖 -->
<script type="text/javascript" src="/libs/codeBlock/codeBlockFuction.js"></script>



<!-- 代码语言 -->

<script type="text/javascript" src="/libs/codeBlock/codeLang.js"></script>


<!-- 代码块复制 -->

<script type="text/javascript" src="/libs/codeBlock/codeCopy.js"></script>


<!-- 代码块收缩 -->

<script type="text/javascript" src="/libs/codeBlock/codeShrink.js"></script>



    </div>
    <div id="toc-aside" class="expanded col l3 hide-on-med-and-down">
        <div class="toc-widget card" style="background-color: white;">
            <div class="toc-title"><i class="far fa-list-alt"></i>&nbsp;&nbsp;TOC</div>
            <div id="toc-content"></div>
        </div>
    </div>
</div>

<!-- TOC 悬浮按钮. -->

<div id="floating-toc-btn" class="hide-on-med-and-down">
    <a class="btn-floating btn-large bg-color">
        <i class="fas fa-list-ul"></i>
    </a>
</div>


<script src="/libs/tocbot/tocbot.min.js"></script>
<script>
    $(function () {
        tocbot.init({
            tocSelector: '#toc-content',
            contentSelector: '#articleContent',
            headingsOffset: -($(window).height() * 0.4 - 45),
            collapseDepth: Number('0'),
            headingSelector: 'h2, h3, h4'
        });

        // Set scroll toc fixed.
        let tocHeight = parseInt($(window).height() * 0.4 - 64);
        let $tocWidget = $('.toc-widget');
        $(window).scroll(function () {
            let scroll = $(window).scrollTop();
            /* add post toc fixed. */
            if (scroll > tocHeight) {
                $tocWidget.addClass('toc-fixed');
            } else {
                $tocWidget.removeClass('toc-fixed');
            }
        });

        
        /* 修复文章卡片 div 的宽度. */
        let fixPostCardWidth = function (srcId, targetId) {
            let srcDiv = $('#' + srcId);
            if (srcDiv.length === 0) {
                return;
            }

            let w = srcDiv.width();
            if (w >= 450) {
                w = w + 21;
            } else if (w >= 350 && w < 450) {
                w = w + 18;
            } else if (w >= 300 && w < 350) {
                w = w + 16;
            } else {
                w = w + 14;
            }
            $('#' + targetId).width(w);
        };

        // 切换TOC目录展开收缩的相关操作.
        const expandedClass = 'expanded';
        let $tocAside = $('#toc-aside');
        let $mainContent = $('#main-content');
        $('#floating-toc-btn .btn-floating').click(function () {
            if ($tocAside.hasClass(expandedClass)) {
                $tocAside.removeClass(expandedClass).hide();
                $mainContent.removeClass('l9');
            } else {
                $tocAside.addClass(expandedClass).show();
                $mainContent.addClass('l9');
            }
            fixPostCardWidth('artDetail', 'prenext-posts');
        });
        
    });
</script>

    

</main>




    <footer class="page-footer bg-color">
    
        <link rel="stylesheet" href="/libs/aplayer/APlayer.min.css">
<style>
    .aplayer .aplayer-lrc p {
        
        display: none;
        
        font-size: 12px;
        font-weight: 700;
        line-height: 16px !important;
    }

    .aplayer .aplayer-lrc p.aplayer-lrc-current {
        
        display: none;
        
        font-size: 15px;
        color: #42b983;
    }

    
    .aplayer.aplayer-fixed.aplayer-narrow .aplayer-body {
        left: -66px !important;
    }

    .aplayer.aplayer-fixed.aplayer-narrow .aplayer-body:hover {
        left: 0px !important;
    }

    
</style>
<div class="">
    
    <div class="row">
        <meting-js class="col l8 offset-l2 m10 offset-m1 s12"
                   server="netease"
                   type="playlist"
                   id="503838841"
                   fixed='true'
                   autoplay='false'
                   theme='#42b983'
                   loop='all'
                   order='random'
                   preload='auto'
                   volume='0.7'
                   list-folded='true'
        >
        </meting-js>
    </div>
</div>

<script src="/libs/aplayer/APlayer.min.js"></script>
<script src="/libs/aplayer/Meting.min.js"></script>

    

    <div class="container row center-align"
         style="margin-bottom: 0px !important;">
        <div class="col s12 m8 l8 copy-right">
            Copyright&nbsp;&copy;
            
                <span id="year">2019-2023</span>
            
            <a href="/about" target="_blank">Jingyi Yu</a>
            |&nbsp;Powered by&nbsp;<a href="https://hexo.io/" target="_blank">Hexo</a>
            |&nbsp;Theme&nbsp;<a href="https://github.com/blinkfox/hexo-theme-matery" target="_blank">Matery</a>
            
            <br>
            
            
            
                
            
            
                <span id="busuanzi_container_site_pv">
                &nbsp;|&nbsp;<i class="far fa-eye"></i>&nbsp;Total visits:&nbsp;
                    <span id="busuanzi_value_site_pv" class="white-color"></span>
            </span>
            
            
                <span id="busuanzi_container_site_uv">
                &nbsp;|&nbsp;<i class="fas fa-users"></i>&nbsp;Total visitors:&nbsp;
                    <span id="busuanzi_value_site_uv" class="white-color"></span>
            </span>
            
            <br>

            <!-- 运行天数提醒. -->
            
            <br>
            
        </div>
        <div class="col s12 m4 l4 social-link social-statis">
    <a href="https://github.com/blinkfox" class="tooltipped" target="_blank" data-tooltip="访问我的GitHub" data-position="top" data-delay="50">
        <i class="fab fa-github"></i>
    </a>



    <a href="mailto:1181062873@qq.com" class="tooltipped" target="_blank" data-tooltip="邮件联系我" data-position="top" data-delay="50">
        <i class="fas fa-envelope-open"></i>
    </a>







    <a href="tencent://AddContact/?fromId=50&fromSubId=1&subcmd=all&uin=1181062873" class="tooltipped" target="_blank" data-tooltip="QQ联系我: 1181062873" data-position="top" data-delay="50">
        <i class="fab fa-qq"></i>
    </a>







    <a href="/atom.xml" class="tooltipped" target="_blank" data-tooltip="RSS 订阅" data-position="top" data-delay="50">
        <i class="fas fa-rss"></i>
    </a>

</div>
    </div>
</footer>

<div class="progress-bar"></div>


    <!-- 搜索遮罩框 -->
<div id="searchModal" class="modal">
    <div class="modal-content">
        <div class="search-header">
            <span class="title"><i class="fas fa-search"></i>&nbsp;&nbsp;Search</span>
            <input type="search" id="searchInput" name="s" placeholder="Please enter a search keyword"
                   class="search-input">
        </div>
        <div id="searchResult"></div>
    </div>
</div>

<script type="text/javascript">
$(function () {
    var searchFunc = function (path, search_id, content_id) {
        'use strict';
        $.ajax({
            url: path,
            dataType: "xml",
            success: function (xmlResponse) {
                // get the contents from search data
                var datas = $("entry", xmlResponse).map(function () {
                    return {
                        title: $("title", this).text(),
                        content: $("content", this).text(),
                        url: $("url", this).text()
                    };
                }).get();
                var $input = document.getElementById(search_id);
                var $resultContent = document.getElementById(content_id);
                $input.addEventListener('input', function () {
                    var str = '<ul class=\"search-result-list\">';
                    var keywords = this.value.trim().toLowerCase().split(/[\s\-]+/);
                    $resultContent.innerHTML = "";
                    if (this.value.trim().length <= 0) {
                        return;
                    }
                    // perform local searching
                    datas.forEach(function (data) {
                        var isMatch = true;
                        var data_title = data.title.trim().toLowerCase();
                        var data_content = data.content.trim().replace(/<[^>]+>/g, "").toLowerCase();
                        var data_url = data.url;
                        data_url = data_url.indexOf('/') === 0 ? data.url : '/' + data_url;
                        var index_title = -1;
                        var index_content = -1;
                        var first_occur = -1;
                        // only match artiles with not empty titles and contents
                        if (data_title !== '' && data_content !== '') {
                            keywords.forEach(function (keyword, i) {
                                index_title = data_title.indexOf(keyword);
                                index_content = data_content.indexOf(keyword);
                                if (index_title < 0 && index_content < 0) {
                                    isMatch = false;
                                } else {
                                    if (index_content < 0) {
                                        index_content = 0;
                                    }
                                    if (i === 0) {
                                        first_occur = index_content;
                                    }
                                }
                            });
                        }
                        // show search results
                        if (isMatch) {
                            str += "<li><a href='" + data_url + "' class='search-result-title'>" + data_title + "</a>";
                            var content = data.content.trim().replace(/<[^>]+>/g, "");
                            if (first_occur >= 0) {
                                // cut out 100 characters
                                var start = first_occur - 20;
                                var end = first_occur + 80;
                                if (start < 0) {
                                    start = 0;
                                }
                                if (start === 0) {
                                    end = 100;
                                }
                                if (end > content.length) {
                                    end = content.length;
                                }
                                var match_content = content.substr(start, end);
                                // highlight all keywords
                                keywords.forEach(function (keyword) {
                                    var regS = new RegExp(keyword, "gi");
                                    match_content = match_content.replace(regS, "<em class=\"search-keyword\">" + keyword + "</em>");
                                });

                                str += "<p class=\"search-result\">" + match_content + "...</p>"
                            }
                            str += "</li>";
                        }
                    });
                    str += "</ul>";
                    $resultContent.innerHTML = str;
                });
            }
        });
    };

    searchFunc('/search.xml', 'searchInput', 'searchResult');
});
</script>

    <!-- 白天和黑夜主题 -->
<div class="stars-con">
    <div id="stars"></div>
    <div id="stars2"></div>
    <div id="stars3"></div>  
</div>

<script>
    function switchNightMode() {
        $('<div class="Cuteen_DarkSky"><div class="Cuteen_DarkPlanet"></div></div>').appendTo($('body')),
        setTimeout(function () {
            $('body').hasClass('DarkMode') 
            ? ($('body').removeClass('DarkMode'), localStorage.setItem('isDark', '0'), $('#sum-moon-icon').removeClass("fa-sun").addClass('fa-moon')) 
            : ($('body').addClass('DarkMode'), localStorage.setItem('isDark', '1'), $('#sum-moon-icon').addClass("fa-sun").removeClass('fa-moon')),
            
            setTimeout(function () {
            $('.Cuteen_DarkSky').fadeOut(1e3, function () {
                $(this).remove()
            })
            }, 2e3)
        })
    }
</script>

    <!-- 回到顶部按钮 -->
<div id="backTop" class="top-scroll">
    <a class="btn-floating btn-large waves-effect waves-light" href="#!">
        <i class="fas fa-arrow-up"></i>
    </a>
</div>


    <script src="/libs/materialize/materialize.min.js"></script>
    <script src="/libs/masonry/masonry.pkgd.min.js"></script>
    <script src="/libs/aos/aos.js"></script>
    <script src="/libs/scrollprogress/scrollProgress.min.js"></script>
    <script src="/libs/lightGallery/js/lightgallery-all.min.js"></script>
    <script src="/js/matery.js"></script>

    

    
    
    

    <!-- 雪花特效 -->
    

    <!-- 鼠标星星特效 -->
    

     
        <script src="https://ssl.captcha.qq.com/TCaptcha.js"></script>
        <script src="/libs/others/TencentCaptcha.js"></script>
        <button id="TencentCaptcha" data-appid="xxxxxxxxxx" data-cbfn="callback" type="button" hidden></button>
    

    <!-- Baidu Analytics -->

    <!-- Baidu Push -->

<script>
    (function () {
        var bp = document.createElement('script');
        var curProtocol = window.location.protocol.split(':')[0];
        if (curProtocol === 'https') {
            bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
        } else {
            bp.src = 'http://push.zhanzhang.baidu.com/push.js';
        }
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(bp, s);
    })();
</script>

    
    <script src="/libs/others/clicklove.js" async="async"></script>
    
    
    <script async src="/libs/others/busuanzi.pure.mini.js"></script>
    

    

    

    <!--腾讯兔小巢-->
    
    

    

    

    
    <script src="/libs/instantpage/instantpage.js" type="module"></script>
    

</body>

</html>
